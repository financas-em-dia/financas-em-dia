<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finan√ßas em Dia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f172a;--card:#020617;--primary:#22c55e;--danger:#ef4444;
      --text:#e5e7eb;--muted:#94a3b8;--input:#020617;--border:#1e293b;
    }
    *{box-sizing:border-box;font-family:system-ui;}
    body{margin:0;background:linear-gradient(180deg,#020617,#0f172a);color:var(--text);padding:12px;}
    .container{max-width:520px;margin:auto;}
    h1{text-align:center;margin:10px 0;font-size:1.4rem;}
    h2{margin:0 0 10px 0;font-size:1.05rem;}
    .hidden{display:none;}
    button{cursor:pointer}

    .box,.form,.list,.chart-box{
      margin-top:15px;background:rgba(255,255,255,0.03);
      border:1px solid var(--border);border-radius:14px;padding:14px;
    }
    .field{margin-bottom:10px;}
    label{font-size:.75rem;color:var(--muted);display:block;margin-bottom:4px;}
    select,input{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
      background:var(--input);color:var(--text);
    }
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);}
    .passbox{position:relative}
    .eye{position:absolute;right:12px;top:32px;cursor:pointer}

    .top-tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
    .top-tabs button{
      flex:1;min-width:120px;padding:10px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,0.05);color:var(--text);font-weight:600;
    }
    .top-tabs button.active{background:linear-gradient(135deg,#22c55e,#16a34a);color:#052e16;}

    .mes-box{text-align:center;margin-bottom:10px;}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .card{
      background:rgba(255,255,255,0.03);border:1px solid var(--border);
      border-radius:14px;padding:12px;
    }
    .card h3{font-size:.75rem;color:var(--muted);margin:0 0 6px;}
    .card .value{font-size:1.1rem;font-weight:600;}
    .card.saldo{grid-column:1/3;text-align:center;}

    button.main{
      width:100%;padding:12px;border:none;border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);color:#052e16;font-weight:700;
    }
    button.sec{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;
      background:transparent;color:var(--text);margin-top:6px;
    }
    .plus{width:36px;margin-left:6px;padding:8px;border-radius:8px;background:#22c55e;border:none;color:#052e16;font-weight:800;}

    .item{
      display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;
      padding:8px 0;border-bottom:1px solid var(--border);font-size:.78rem;
    }
    .item:last-child{border-bottom:none;}
    .cat{color:var(--muted);font-size:.7rem;}
    .valor{text-align:right;min-width:90px;}
    .valor.rec{color:var(--primary);} .valor.desp{color:var(--danger);}
    .actions{display:flex;gap:4px;}
    .actions button{font-size:.6rem;border:none;border-radius:6px;padding:4px 6px;}
    .pay{background:#22c55e;color:#052e16;}
    .back{background:#3b82f6;color:#fff;}
    .edit{background:#f59e0b;color:#000;}
    .del{background:#ef4444;color:#fff;}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .hint{font-size:.75rem;color:var(--muted);line-height:1.35}
    .pill{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:.7rem;color:var(--muted)}
  </style>
</head>

<body>
  <div class="container">

    <!-- LOGIN -->
    <div id="loginScreen">
      <h1>üîê Finan√ßas em Dia</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailLogin" type="email"></div>
        <div class="field passbox">
          <label>Senha</label>
          <input id="senhaLogin" type="password">
          <span class="eye" onclick="toggle('senhaLogin')">üëÅ</span>
        </div>
        <button class="main" id="btnLogin">Entrar</button>
        <button class="sec" onclick="showCadastro()">Primeiro acesso</button>
        <button class="sec" id="btnReset">Esqueci minha senha</button>
        <hr style="margin:14px 0;border-color:#1e293b">
        <button class="main" id="btnGoogle">Entrar com Google</button>
      </div>
    </div>

    <!-- CADASTRO -->
    <div id="cadastroScreen" class="hidden">
      <h1>üìù Criar Conta</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailCad" type="email"></div>
        <div class="field passbox">
          <label>Senha</label>
          <input id="senhaCad" type="password">
          <span class="eye" onclick="toggle('senhaCad')">üëÅ</span>
        </div>
        <div class="field passbox">
          <label>Confirmar Senha</label>
          <input id="senhaConf" type="password">
          <span class="eye" onclick="toggle('senhaConf')">üëÅ</span>
        </div>
        <button class="main" id="btnCadastrar">Cadastrar</button>
        <button class="sec" onclick="showLogin()">Voltar</button>
      </div>
    </div>

    <!-- APP -->
    <div id="appScreen" class="hidden">
      <h1>üí∞ Finan√ßas em Dia</h1>

      <div class="top-tabs">
        <button id="tabMes" class="active" onclick="showTela('mes')">M√™s</button>
        <button id="tabAno" onclick="showTela('ano')">Resumo Anual</button>
        <button id="tabContas" onclick="showTela('contas')">Contas</button>
        <button id="tabTransf" onclick="showTela('transf')">Transfer√™ncias</button>
      </div>

      <!-- TELA M√äS -->
      <div id="telaMes">
        <div class="mes-box">
          <select id="mesSelecionado" onchange="renderMes()"></select>
        </div>

        <div class="cards">
          <div class="card"><h3>Receitas Pagas</h3><div class="value" id="rMes">R$0</div></div>
          <div class="card"><h3>Despesas Pagas</h3><div class="value" id="dMes">R$0</div></div>
          <div class="card saldo"><h3>Saldo</h3><div class="value" id="sMes">R$0</div></div>
        </div>

        <div class="form">
          <h2>Novo Lan√ßamento</h2>

          <div class="row2">
            <div class="field">
              <label>Tipo</label>
              <select id="tipo">
                <option value="">Selecione</option>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>

            <div class="field">
              <label>Conta</label>
              <select id="contaLanc"></select>
            </div>
          </div>

          <div class="field">
            <label>Categoria</label>
            <div style="display:flex;">
              <select id="categoria"></select>
              <button class="plus" onclick="novaCategoria()">+</button>
            </div>
          </div>

          <div class="field"><label>Descri√ß√£o</label><input id="desc"/></div>
          <div class="row2">
            <div class="field"><label>Valor (TOTAL)</label><input id="valor" type="number" step="0.01"/></div>
            <div class="field"><label>Data</label><input id="data" type="date"/></div>
          </div>

          <div class="row2">
            <div class="field">
              <label>Tipo de Lan√ßamento</label>
              <select id="repete">
                <option value="">Selecione</option>
                <option value="variavel">√önica</option>
                <option value="fixa">Fixa</option>
                <option value="parcelada">Parcelada</option>
              </select>
            </div>

            <div class="field hidden" id="parcelasBox">
              <label>Parcelas</label>
              <input id="parcelas" type="number" value="2" min="2"/>
            </div>
          </div>

          <p class="hint">
            <span class="pill">Dica</span>
            Transfer√™ncias entre contas ficam na aba <b>Transfer√™ncias</b> e n√£o entram em receitas/despesas.
          </p>

          <button class="main" onclick="adicionarLancamento()">Adicionar</button>
        </div>

        <div class="list" id="listaMes"></div>
        <div class="chart-box"><canvas id="graficoMes"></canvas></div>
      </div>

      <!-- TELA ANO -->
      <div id="telaAno" class="hidden">
        <div class="cards">
          <div class="card"><h3>Receitas Ano</h3><div class="value" id="rAno">R$0</div></div>
          <div class="card"><h3>Despesas Ano</h3><div class="value" id="dAno">R$0</div></div>
          <div class="card saldo"><h3>Saldo Ano</h3><div class="value" id="sAno">R$0</div></div>
        </div>
        <div class="chart-box"><canvas id="graficoAno"></canvas></div>
      </div>

      <!-- TELA CONTAS -->
      <div id="telaContas" class="hidden">
        <div class="box">
          <h2>Minhas Contas</h2>
          <div class="row2">
            <div class="field"><label>Nome</label><input id="contaNome" placeholder="Ex: Ita√∫ Casa"></div>
            <div class="field">
              <label>Tipo</label>
              <select id="contaTipo">
                <option value="corrente">Corrente</option>
                <option value="poupanca">Poupan√ßa</option>
                <option value="cofrinho">Cofrinho</option>
                <option value="cartao">Cart√£o</option>
              </select>
            </div>
          </div>
          <div class="field"><label>Saldo inicial</label><input id="contaSaldoInicial" type="number" step="0.01" value="0"></div>
          <button class="main" onclick="criarConta()">Criar conta</button>
          <div class="hint" style="margin-top:10px">
            Se voc√™ j√° tinha lan√ßamentos antigos, eles v√£o cair na <b>Conta Padr√£o</b> automaticamente.
          </div>
        </div>

        <div class="list" id="listaContas"></div>
      </div>

      <!-- TELA TRANSFER√äNCIAS -->
      <div id="telaTransf" class="hidden">
        <div class="form">
          <h2>Nova Transfer√™ncia</h2>
          <div class="row2">
            <div class="field"><label>Origem</label><select id="tOrigem"></select></div>
            <div class="field"><label>Destino</label><select id="tDestino"></select></div>
          </div>
          <div class="row2">
            <div class="field"><label>Valor</label><input id="tValor" type="number" step="0.01"></div>
            <div class="field"><label>Data</label><input id="tData" type="date"></div>
          </div>
          <div class="field"><label>Descri√ß√£o</label><input id="tDesc" placeholder="Ex: Repasse despesas familiares"></div>
          <button class="main" onclick="criarTransferencia()">Salvar transfer√™ncia</button>
        </div>

        <div class="box">
          <h2>Transfer√™ncias do m√™s</h2>
          <div class="hint">Mostramos por m√™s selecionado na aba ‚ÄúM√™s‚Äù.</div>
        </div>
        <div class="list" id="listaTransf"></div>
      </div>

      <button class="sec" onclick="logout()">Sair</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ‚úÖ seu config (mantido)
    const firebaseConfig = {
      apiKey: "AIzaSyBAWyMjRVAODIVkC5w95nu9MliqNUMb8ZY",
      authDomain: "controle-financeiro-dffee.firebaseapp.com",
      projectId: "controle-financeiro-dffee",
      storageBucket: "controle-financeiro-dffee.firebasestorage.app",
      messagingSenderId: "470526358884",
      appId: "1:470526358884:web:0dcd3dffb5c0924dadf671"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // estado
    const mesesNomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    let userId = null;

    let categorias = [];
    let contas = [];          // {id, nome, tipo, saldoInicial}
    let dados = [];           // lancamentos
    let transferencias = [];  // transferencias

    // gr√°ficos
    let grafMes = null;
    let grafAno = null;

    // --------- helpers UI ----------
    window.toggle = (id) => {
      const i = document.getElementById(id);
      i.type = i.type === "password" ? "text" : "password";
    };

    window.showCadastro = () => {
      loginScreen.classList.add("hidden");
      cadastroScreen.classList.remove("hidden");
    };
    window.showLogin = () => {
      cadastroScreen.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    };

    // tabs
    const telas = {
      mes: { el: () => telaMes, tab: () => tabMes },
      ano: { el: () => telaAno, tab: () => tabAno },
      contas: { el: () => telaContas, tab: () => tabContas },
      transf: { el: () => telaTransf, tab: () => tabTransf },
    };

    window.showTela = (nome) => {
      Object.keys(telas).forEach(k=>{
        telas[k].el().classList.toggle("hidden", k !== nome);
        telas[k].tab().classList.toggle("active", k === nome);
      });
      if (nome === "contas") renderContas();
      if (nome === "transf") renderTransferenciasMes();
    };

    // --------- Auth buttons ----------
    btnLogin.onclick = () =>
      signInWithEmailAndPassword(auth, emailLogin.value, senhaLogin.value)
        .catch(() => alert("Email ou senha inv√°lidos"));

    btnCadastrar.onclick = () => {
      if (senhaCad.value !== senhaConf.value) return alert("As senhas n√£o conferem");
      createUserWithEmailAndPassword(auth, emailCad.value, senhaCad.value)
        .catch(() => alert("Erro ao criar conta"));
    };

    btnReset.onclick = () => {
      if (!emailLogin.value) return alert("Digite seu email");
      sendPasswordResetEmail(auth, emailLogin.value)
        .then(() => alert("Email enviado"))
        .catch(() => alert("Erro ao enviar email"));
    };

    btnGoogle.onclick = () =>
      signInWithPopup(auth, provider).catch(() => alert("Erro no login com Google"));

    window.logout = () => signOut(auth);

    // --------- init meses ----------
    mesesNomes.forEach((m, i) => {
      const o = document.createElement("option");
      o.value = String(i);
      o.text = m;
      if (i === new Date().getMonth()) o.selected = true;
      mesSelecionado.appendChild(o);
    });
    data.valueAsDate = new Date();
    tData.valueAsDate = new Date();

    repete.onchange = () => {
      parcelasBox.classList.toggle("hidden", repete.value !== "parcelada");
    };

    // --------- Loaders ----------
    async function garantirContaPadrao() {
      // cria "Conta Padr√£o" se n√£o houver contas
      const snap = await getDocs(collection(db, "users", userId, "contas"));
      if (snap.size === 0) {
        await addDoc(collection(db, "users", userId, "contas"), {
          nome: "Conta Padr√£o",
          tipo: "corrente",
          saldoInicial: 0,
          criadoEm: new Date()
        });
      }
    }

    async function carregarContas() {
      contas = [];
      const snap = await getDocs(collection(db, "users", userId, "contas"));
      snap.forEach(d => contas.push({ id: d.id, ...d.data() }));
      // ordena: padr√£o primeiro
      contas.sort((a,b)=>{
        if ((a.nome||"").toLowerCase().includes("padr√£o")) return -1;
        if ((b.nome||"").toLowerCase().includes("padr√£o")) return 1;
        return (a.nome||"").localeCompare(b.nome||"");
      });
      preencherSelectContas();
    }

    function preencherSelectContas() {
      // select do lan√ßamento
      contaLanc.innerHTML = "";
      contas.forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.text = `${c.nome} (${c.tipo})`;
        contaLanc.appendChild(o);
      });

      // selects da transfer√™ncia
      tOrigem.innerHTML = "";
      tDestino.innerHTML = "";
      contas.forEach(c=>{
        const o1 = document.createElement("option");
        o1.value = c.id; o1.text = c.nome;
        const o2 = o1.cloneNode(true);
        tOrigem.appendChild(o1);
        tDestino.appendChild(o2);
      });
    }

    async function carregarCategorias() {
      categorias = [];
      const snap = await getDocs(collection(db, "users", userId, "categorias"));
      snap.forEach(d => categorias.push(d.data().nome));

      if (categorias.length === 0) {
        const base = ["Sal√°rio","Alimenta√ß√£o","Aluguel","Transporte","Lazer"];
        for (const c of base) await addDoc(collection(db, "users", userId, "categorias"), { nome: c });
        return carregarCategorias();
      }

      categoria.innerHTML = '<option value="">Selecione</option>';
      categorias.forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.text = c;
        categoria.appendChild(o);
      });
    }

    async function carregarLancamentos() {
      dados = [];
      const snap = await getDocs(collection(db, "users", userId, "lancamentos"));
      snap.forEach(d => dados.push({ id: d.id, ...d.data() }));
    }

    async function carregarTransferencias() {
      transferencias = [];
      const snap = await getDocs(collection(db, "users", userId, "transferencias"));
      snap.forEach(d => transferencias.push({ id: d.id, ...d.data() }));
    }

    async function carregarTudo() {
      await garantirContaPadrao();
      await carregarContas();
      await carregarCategorias();
      await carregarLancamentos();
      await carregarTransferencias();
      renderMes();
      renderAno();
      renderContas();
      renderTransferenciasMes();
    }

    // --------- criar categoria ----------
    window.novaCategoria = async () => {
      const n = prompt("Nova categoria:");
      if (!n) return;
      await addDoc(collection(db,"users",userId,"categorias"),{nome:n});
      await carregarCategorias();
    };

    // --------- criar conta ----------
    window.criarConta = async () => {
      const nome = (contaNome.value || "").trim();
      const tipo = contaTipo.value;
      const saldoInicial = Number(contaSaldoInicial.value || 0);

      if (!nome) return alert("Digite um nome para a conta.");
      await addDoc(collection(db, "users", userId, "contas"), {
        nome, tipo, saldoInicial, criadoEm: new Date()
      });

      contaNome.value = "";
      contaSaldoInicial.value = "0";
      await carregarContas();
      renderContas();
      alert("Conta criada!");
    };

    // --------- criar transferencia ----------
    window.criarTransferencia = async () => {
      const origemId = tOrigem.value;
      const destinoId = tDestino.value;
      const valor = Number(tValor.value || 0);
      const dataStr = tData.value;
      const desc = (tDesc.value || "").trim();

      if (!origemId || !destinoId) return alert("Selecione origem e destino.");
      if (origemId === destinoId) return alert("Origem e destino devem ser diferentes.");
      if (!valor || valor <= 0) return alert("Informe um valor v√°lido.");
      if (!dataStr) return alert("Informe a data.");

      const mes = new Date(dataStr).getMonth();

      await addDoc(collection(db,"users",userId,"transferencias"),{
        origemId, destinoId, valor,
        data: dataStr,
        mes,
        desc,
        status: "confirmada",
        criadoEm: new Date()
      });

      tValor.value = "";
      tDesc.value = "";
      await carregarTransferencias();
      renderTransferenciasMes();
      renderContas();
      alert("Transfer√™ncia salva!");
    };

    // --------- lan√ßar receitas/despesas ----------
    window.adicionarLancamento = async () => {
      if (!tipo.value || !categoria.value || !valor.value || !data.value || !repete.value) {
        return alert("Preencha todos os campos");
      }

      // conta selecionada (fallback: primeira conta)
      const contaId = contaLanc.value || (contas[0]?.id ?? null);

      const valorTotal = Number(valor.value);
      const dataStr = data.value;
      const mesBase = new Date(dataStr).getMonth();
      const grupo = String(Date.now()) + "_" + Math.floor(Math.random()*1e6);

      const base = {
        tipo: tipo.value,
        cat: categoria.value,
        desc: desc.value || "",
        mes: mesBase,
        data: dataStr,
        grupo,
        status: "pendente",
        contaId: contaId
      };

      async function salvar(o){ await addDoc(collection(db,"users",userId,"lancamentos"), o); }

      if (repete.value === "fixa") {
        for (let m=mesBase; m<12; m++) {
          await salvar({ ...base, mes:m, valor:valorTotal, fixed:true });
        }
      } else if (repete.value === "parcelada") {
        const p = Number(parcelas.value || 2);
        const vp = valorTotal / p;
        for (let i=0; i<p; i++) {
          await salvar({
            ...base,
            mes:(mesBase+i)%12,
            valor:vp,
            parcela:i+1,
            total:p
          });
        }
      } else {
        await salvar({ ...base, valor:valorTotal });
      }

      // limpar
      desc.value=""; valor.value=""; repete.value=""; parcelas.value=2;
      parcelasBox.classList.add("hidden");

      await carregarLancamentos();
      renderMes();
      renderAno();
      renderContas();
    };

    // --------- a√ß√µes item ----------
    window.excluir = async (id) => {
      const item = dados.find(i=>i.id===id);
      if (!item) return;

      // apagar todos do mesmo grupo (pendentes e pagos) para n√£o deixar ‚Äúpeda√ßos‚Äù
      const q = query(collection(db,"users",userId,"lancamentos"), where("grupo","==",item.grupo));
      const snap = await getDocs(q);
      for (const d of snap.docs) await deleteDoc(d.ref);

      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    window.pagar = async (id) => {
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pago"});
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    window.voltar = async (id) => {
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pendente"});
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    window.editar = async (id) => {
      const l = dados.find(i=>i.id===id);
      if (!l) return;
      const nv = prompt("Novo valor:", String(l.valor ?? ""));
      if (nv === null) return;
      const num = Number(nv);
      if (!Number.isFinite(num) || num < 0) return alert("Valor inv√°lido.");
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{valor:num});
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    // --------- c√°lculos ----------
    function nomeConta(id){
      const c = contas.find(x=>x.id===id);
      return c ? c.nome : "Conta Padr√£o";
    }

    function saldoConta(contaId){
      const conta = contas.find(c=>c.id===contaId);
      let saldo = Number(conta?.saldoInicial || 0);

      // lan√ßamentos pagos impactam saldo
      for (const l of dados) {
        const lConta = l.contaId || contas[0]?.id; // fallback
        if (l.status !== "pago") continue;
        if (lConta !== contaId) continue;
        if (l.tipo === "receita") saldo += Number(l.valor||0);
        if (l.tipo === "despesa") saldo -= Number(l.valor||0);
      }

      // transfer√™ncias confirmadas impactam saldo
      for (const t of transferencias) {
        if (t.status !== "confirmada") continue;
        if (t.origemId === contaId) saldo -= Number(t.valor||0);
        if (t.destinoId === contaId) saldo += Number(t.valor||0);
      }

      return saldo;
    }

    // --------- render m√™s ----------
    window.renderMes = () => {
      const mes = Number(mesSelecionado.value);
      let r = 0, d = 0;
      const cat = {};

      listaMes.innerHTML = "<h2>Lan√ßamentos</h2>";

      const itensMes = dados.filter(i => Number(i.mes) === mes);

      // ordenar por data (se tiver)
      itensMes.sort((a,b)=> String(a.data||"").localeCompare(String(b.data||"")));

      for (const i of itensMes) {
        if (i.status === "pago") {
          if (i.tipo === "receita") r += Number(i.valor||0);
          else d += Number(i.valor||0);

          if (i.tipo === "despesa") cat[i.cat] = (cat[i.cat] || 0) + Number(i.valor||0);
        }

        let info = i.desc || "";
        if (i.parcela) info += ` (${i.parcela}/${i.total})`;
        if (i.fixed) info += " (Fixa)";
        const contaNome = nomeConta(i.contaId || contas[0]?.id);
        info += ` ‚Ä¢ ${contaNome} ‚Ä¢ ${i.status}`;

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            ${i.cat}<br>
            <span class="cat">${info}</span>
          </div>
          <div class="valor ${i.tipo==='receita'?'rec':'desp'}">R$ ${Number(i.valor||0).toFixed(2)}</div>
          <div class="actions">
            ${
              i.status==="pendente"
                ? `<button class="pay" onclick="pagar('${i.id}')">‚úî</button>`
                : `<button class="back" onclick="voltar('${i.id}')">‚Ü©</button>`
            }
            <button class="edit" onclick="editar('${i.id}')">‚úè</button>
            <button class="del" onclick="excluir('${i.id}')">‚úñ</button>
          </div>
        `;
        listaMes.appendChild(div);
      }

      rMes.innerText = `R$ ${r.toFixed(2)}`;
      dMes.innerText = `R$ ${d.toFixed(2)}`;
      sMes.innerText = `R$ ${(r-d).toFixed(2)}`;

      // gr√°fico do m√™s
      if (!grafMes) {
        grafMes = new Chart(graficoMes, {
          type:'pie',
          data:{ labels:[], datasets:[{ data:[], backgroundColor:["#22c55e","#3b82f6","#f59e0b","#ef4444","#a855f7","#14b8a6"] }] }
        });
      }
      grafMes.data.labels = Object.keys(cat);
      grafMes.data.datasets[0].data = Object.values(cat);
      grafMes.update();

      // transfer√™ncias do m√™s (aba transf)
      renderTransferenciasMes();
    };

    // --------- render ano ----------
    function renderAno(){
      let rM = Array(12).fill(0), dM = Array(12).fill(0), r=0, d=0;
      for (const i of dados) {
        if (i.status !== "pago") continue;
        const m = Number(i.mes);
        if (i.tipo === "receita") { r += Number(i.valor||0); rM[m] += Number(i.valor||0); }
        else { d += Number(i.valor||0); dM[m] += Number(i.valor||0); }
      }

      rAno.innerText = `R$ ${r.toFixed(2)}`;
      dAno.innerText = `R$ ${d.toFixed(2)}`;
      sAno.innerText = `R$ ${(r-d).toFixed(2)}`;

      if (!grafAno) {
        grafAno = new Chart(graficoAno, {
          type:'bar',
          data:{ labels: mesesNomes, datasets:[
            {label:'Receitas', data:[], backgroundColor:"#22c55e"},
            {label:'Despesas', data:[], backgroundColor:"#ef4444"}
          ]}
        });
      }
      grafAno.data.datasets[0].data = rM;
      grafAno.data.datasets[1].data = dM;
      grafAno.update();
    }
    window.renderAno = renderAno;

    // --------- render contas ----------
    function renderContas(){
      listaContas.innerHTML = "<h2>Saldos por conta</h2>";
      contas.forEach(c=>{
        const saldo = saldoConta(c.id);
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            ${c.nome}<br>
            <span class="cat">${c.tipo} ‚Ä¢ saldo inicial: R$ ${Number(c.saldoInicial||0).toFixed(2)}</span>
          </div>
          <div class="valor rec">R$ ${saldo.toFixed(2)}</div>
          <div></div>
        `;
        listaContas.appendChild(div);
      });
    }
    window.renderContas = renderContas;

    // --------- render transfer√™ncias m√™s ----------
    function renderTransferenciasMes(){
      const mes = Number(mesSelecionado.value);
      listaTransf.innerHTML = "";

      const itens = transferencias
        .filter(t => Number(t.mes) === mes)
        .sort((a,b)=> String(a.data||"").localeCompare(String(b.data||"")));

      if (itens.length === 0) {
        listaTransf.innerHTML = `<div class="hint">Nenhuma transfer√™ncia neste m√™s.</div>`;
        return;
      }

      itens.forEach(t=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            ${nomeConta(t.origemId)} ‚Üí ${nomeConta(t.destinoId)}<br>
            <span class="cat">${t.desc || ""} ‚Ä¢ ${t.data || ""}</span>
          </div>
          <div class="valor">R$ ${Number(t.valor||0).toFixed(2)}</div>
          <div></div>
        `;
        listaTransf.appendChild(div);
      });
    }
    window.renderTransferenciasMes = renderTransferenciasMes;

    // --------- Auth state ----------
    onAuthStateChanged(auth, async (u) => {
      if (u) {
        userId = u.uid;
        loginScreen.classList.add("hidden");
        cadastroScreen.classList.add("hidden");
        appScreen.classList.remove("hidden");
        await carregarTudo();
      } else {
        appScreen.classList.add("hidden");
        showLogin();
      }
    });

  </script>
</body>
</html>


