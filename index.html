<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finan√ßas em Dia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1:#020617;
      --bg2:#0b1224;
      --card: rgba(255,255,255,0.05);
      --card2: rgba(255,255,255,0.07);
      --border: rgba(148,163,184,0.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --blue:#3b82f6;
      --shadow: 0 10px 35px rgba(0,0,0,0.35);
    }

    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      margin:0;
      background: radial-gradient(1200px 500px at 10% -10%, rgba(34,197,94,0.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 0%, rgba(59,130,246,0.16), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      padding:14px;
    }

    .container{max-width:620px;margin:auto;}
    h1{text-align:center;margin:10px 0 12px;font-size:1.35rem;letter-spacing:.2px;}
    h2{margin:0 0 10px 0;font-size:1.05rem;}
    .hidden{display:none!important;}
    button{cursor:pointer}

    .box,.form,.list,.chart-box{
      margin-top:14px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .field{margin-bottom:10px;}
    label{font-size:.78rem;color:var(--muted);display:block;margin-bottom:6px;}

    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(2,6,23,0.45);
      color: var(--text);
      outline:none;
    }
    input:focus,select:focus{
      border-color: rgba(34,197,94,0.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.12);
    }
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);opacity:.85;}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    @media (max-width:520px){
      .row3{grid-template-columns:1fr;gap:10px;}
      .row2{grid-template-columns:1fr;gap:10px;}
    }

    .top-tabs{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .top-tabs button{
      flex:1;
      min-width:130px;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:800;
      transition: transform .08s ease, background .2s ease;
    }
    .top-tabs button:hover{transform: translateY(-1px);}
    .top-tabs button.active{
      background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(22,163,74,0.95));
      color:#052e16;
      border-color: transparent;
    }

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;}
    .card{
      background: var(--card2);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
    }
    .card.saldo{grid-column:1/3;text-align:center;}
    .card h3{font-size:.78rem;color:var(--muted);margin:0 0 8px;}
    .card .value{font-size:1.25rem;font-weight:900;letter-spacing:.2px;}
    .card .sub{font-size:.78rem;color:var(--muted);margin-top:4px}

    button.main{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      color:#052e16;
      font-weight:950;
    }
    button.sec{
      width:100%;
      padding:11px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:800;
      margin-top:8px;
    }
    .btnGhost{
      width:100%;
      padding:11px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:850;
      margin-top:8px;
    }
    .btnGhost:hover{background: rgba(255,255,255,0.07);}

    .plus{
      width:44px;margin-left:8px;padding:10px;border-radius:14px;
      background: rgba(34,197,94,1);border:none;color:#052e16;font-weight:950;
    }

    .mini{font-size:.78rem;color:var(--muted);line-height:1.35}

    /* Accordion */
    details.accordion{
      border:1px solid rgba(148,163,184,0.18);
      border-radius:18px;
      background: rgba(255,255,255,0.03);
      overflow:hidden;
      margin-top:14px;
      box-shadow: var(--shadow);
    }
    details.accordion summary{
      list-style:none;
      cursor:pointer;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:950;
      color:var(--text);
    }
    details.accordion summary::-webkit-details-marker{display:none;}
    .accBody{padding:0 14px 14px 14px;}
    .chev{
      width:40px;height:36px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }

    /* Listas */
    .tx{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(148,163,184,0.14);
    }
    .tx:last-child{border-bottom:none;}
    .tx .title{font-weight:900;font-size:.93rem}
    .tx .meta{font-size:.78rem;color:var(--muted);margin-top:2px}
    .tx .right{display:flex;align-items:center;gap:10px;}

    .amount{
      font-weight:950;
      min-width:125px;
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .amount.rec{color:var(--primary);}
    .amount.desp{color:var(--danger);}

    .iconBtn{
      /* Status do lan√ßamento */
.iconBtn.pending{
  border-color: rgba(239,68,68,0.55); /* vermelho */
  color: var(--danger);
}
.iconBtn.paid{
  border-color: rgba(34,197,94,0.55); /* verde */
  color: var(--primary);
}

      width:44px;height:40px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:hover{background: rgba(255,255,255,0.07);}

    /* Status (novo): pendente vermelho, pago verde */
    .iconBtn.pending{border-color: rgba(239,68,68,0.55); color: var(--danger);}
    .iconBtn.paid{border-color: rgba(34,197,94,0.55); color: var(--primary);}

    /* Contas em grid 2 colunas */
    .accountsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    @media (max-width:520px){ .accountsGrid{grid-template-columns:1fr;} }

    .acc{
      background: var(--card2);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .acc .name{font-weight:950}
    .acc .type{font-size:.78rem;color:var(--muted);margin-top:2px}
    .acc .bal{font-weight:1000;font-size:1.18rem;font-variant-numeric: tabular-nums;}
    .acc .bal.pos{color:var(--primary);}
    .acc .bal.neg{color:var(--danger);}

    .tr{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(148,163,184,0.14);
    }
    .tr:last-child{border-bottom:none;}
    .tr .title{font-weight:900;font-size:.92rem}
    .tr .meta{font-size:.78rem;color:var(--muted);margin-top:2px}
    .tr .val{font-weight:950;min-width:115px;text-align:right;font-variant-numeric: tabular-nums;}

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index: 999999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .modal{
      width:100%;
      max-width:620px;
      background: rgba(2,6,23,0.95);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid rgba(148,163,184,0.14);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .modalTitle{font-weight:950;font-size:.95rem;color: var(--text);}
    .modalClose{
      width:42px;height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
    }
    .modalBody{padding:10px 14px 14px 14px;}
    .modalBtn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
      text-align:left;
      margin-bottom:10px;
    }
    .modalBtn:hover{background: rgba(255,255,255,0.07);}
    .modalBtn.edit{border-color: rgba(245,158,11,0.35); color: var(--warn);}
    .modalBtn.del{border-color: rgba(239,68,68,0.35); color: var(--danger);}
    .modalBtn.ok{border-color: rgba(34,197,94,0.35); color: var(--primary);}

    /* Lan√ßamentos em 2 colunas */
    @media (max-width:520px){ .monthGrid{grid-template-columns:1fr;} }

  </style>
</head>

<body>
  <div class="container">

    <!-- LOGIN -->
    <div id="loginScreen">
      <h1>üîê Finan√ßas em Dia</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailLogin" type="email"></div>
        <div class="field"><label>Senha</label><input id="senhaLogin" type="password"></div>
        <button class="main" id="btnLogin">Entrar</button>
        <button class="sec" onclick="showCadastro()">Primeiro acesso</button>
        <button class="sec" id="btnReset">Esqueci minha senha</button>
        <hr style="margin:14px 0;border-color:rgba(148,163,184,0.25)">
        <button class="main" id="btnGoogle">Entrar com Google</button>
      </div>
    </div>

    <!-- CADASTRO -->
    <div id="cadastroScreen" class="hidden">
      <h1>üìù Criar Conta</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailCad" type="email"></div>
        <div class="field"><label>Senha</label><input id="senhaCad" type="password"></div>
        <div class="field"><label>Confirmar Senha</label><input id="senhaConf" type="password"></div>
        <button class="main" id="btnCadastrar">Cadastrar</button>
        <button class="sec" onclick="showLogin()">Voltar</button>
      </div>
    </div>

    <!-- APP -->
    <div id="appScreen" class="hidden">
      <h1>üí∞ Finan√ßas em Dia</h1>

      <!-- Ano selecionado -->
      <div class="box" style="margin-top:0;">
        <div class="row2">
          <div class="field" style="margin-bottom:0;">
            <label>Ano</label>
            <select id="anoSelecionado"></select>
          </div>
          <div class="field" style="margin-bottom:0;">
            <label>Atalhos</label>
            <button class="btnGhost" onclick="showTela('ano')">Abrir Resumo Anual</button>
          </div>
        </div>
        <div class="mini">Ao virar o ano, √© s√≥ trocar o seletor (o app separa seus dados por <b>ano</b>).</div>
      </div>

      <div class="top-tabs">
        <button id="tabAno" class="active" onclick="showTela('ano')">Resumo Anual</button>
        <button id="tabMes" onclick="showTela('mes')">M√™s</button>
        <button id="tabContas" onclick="showTela('contas')">Contas</button>
        <button id="tabTransf" onclick="showTela('transf')">Transfer√™ncias</button>
        <!-- REMOVIDO: bot√£o grande de categorias -->
      </div>

      <!-- TELA ANO -->
      <div id="telaAno">
        <div class="cards">
          <div class="card"><h3>Receitas do Ano</h3><div class="value" id="rAno">R$0</div></div>
          <div class="card"><h3>Despesas do Ano</h3><div class="value" id="dAno">R$0</div></div>
          <div class="card saldo">
            <h3>Saldo do Ano</h3>
            <div class="value" id="sAno">R$0</div>
            <div class="sub">Somente lan√ßamentos pagos</div>
          </div>
        </div>

        <div class="box">
          <h2>Saldo Total (todas as contas)</h2>
          <div class="card" style="margin-top:10px;">
            <h3>Saldo Total</h3>
            <div class="value" id="saldoTotal">R$0</div>
          </div>
        </div>

        <div class="chart-box"><canvas id="graficoAno"></canvas></div>
      </div>

      <!-- TELA M√äS -->
      <div id="telaMes" class="hidden">
        <div class="box">
          <div class="field">
            <label>M√™s</label>
            <select id="mesSelecionado"></select>
          </div>
        </div>

        <div class="cards">
          <div class="card"><h3>Receitas Pagas</h3><div class="value" id="rMes">R$0</div></div>
          <div class="card"><h3>Despesas Pagas</h3><div class="value" id="dMes">R$0</div></div>
          <div class="card saldo"><h3>Saldo do M√™s</h3><div class="value" id="sMes">R$0</div><div class="sub">Somente pagos</div></div>
        </div>

        <!-- Filtros -->
        <details class="accordion" id="accFiltros">
          <summary>
            <span>üîé Filtros</span>
            <span class="chev">‚åÑ</span>
          </summary>
          <div class="accBody">
            <div class="row3">
              <div class="field">
                <label>Conta</label>
                <select id="fConta"></select>
              </div>
              <div class="field">
                <label>Status</label>
                <select id="fStatus">
                  <option value="todos">Todos</option>
                  <option value="pendente">Pendente</option>
                  <option value="pago">Pago</option>
                </select>
              </div>
              <div class="field">
                <label>Buscar</label>
                <input id="fBusca" placeholder="categoria ou descri√ß√£o">
              </div>
            </div>
            <div class="field">
  <label>Tipo</label>
  <select id="fTipoLanc">
    <option value="todos">Todos</option>
    <option value="unica">√önica</option>
    <option value="fixa">Fixa</option>
    <option value="parcelada">Parcelada</option>
  </select>
</div>

            <button class="btnGhost" onclick="limparFiltros()">Limpar filtros</button>
          </div>
        </details>

        <!-- Novo lan√ßamento -->
        <details class="accordion" id="accNovoLanc">
          <summary>
            <span>‚ûï Novo lan√ßamento</span>
            <span class="chev">‚åÑ</span>
          </summary>
          <div class="accBody">
            <div class="row2">
              <div class="field">
                <label>Tipo</label>
                <select id="tipo">
                  <option value="">Selecione</option>
                  <option value="receita">Receita</option>
                  <option value="despesa">Despesa</option>
                </select>
              </div>
              <div class="field">
                <label>Conta</label>
                <select id="contaLanc"></select>
              </div>
            </div>

            <div class="field">
              <label>Categoria</label>
              <div style="display:flex;align-items:center;">
                <select id="categoria"></select>
                <button class="plus" onclick="abrirGerenciarCategorias()" title="Gerenciar categorias">‚öô</button>
              </div>
            </div>

            <div class="field"><label>Descri√ß√£o</label><input id="desc"/></div>

            <div class="row2">
              <div class="field"><label>Valor (TOTAL)</label><input id="valor" type="number" step="0.01"/></div>
              <div class="field"><label>Data</label><input id="data" type="date"/></div>
            </div>

            <!-- NOVO: status j√° na cria√ß√£o -->
            <div class="field">
              <label>Status</label>
              <select id="statusNovo">
                <option value="pendente" selected>Pendente</option>
                <option value="pago">Pago</option>
              </select>
            </div>

            <div class="row2">
              <div class="field">
                <label>Tipo de Lan√ßamento</label>
                <select id="repete">
                  <option value="">Selecione</option>
                  <option value="variavel">√önica</option>
                  <option value="fixa">Fixa</option>
                  <option value="parcelada">Parcelada</option>
                </select>
              </div>
              <div class="field hidden" id="parcelasBox">
                <label>Parcelas</label>
                <input id="parcelas" type="number" value="2" min="2"/>
              </div>
            </div>

            <button class="main" onclick="adicionarLancamento()">Adicionar</button>
          </div>
        </details>

        <!-- LISTAS EM MENUS SUSPENSOS -->
        <div class="list">
          <details class="accordion" id="accReceitas" open>
            <summary>
              <span>üíö Receitas</span>
              <span class="chev">‚åÑ</span>
            </summary>
            <div class="accBody">
              <div id="listaReceitas"></div>
            </div>
          </details>

          <details class="accordion" id="accDespesas" open>
            <summary>
              <span>‚ù§Ô∏è Despesas</span>
              <span class="chev">‚åÑ</span>
            </summary>
            <div class="accBody">
              <div id="listaDespesas"></div>
            </div>
          </details>
        </div>


        <div class="chart-box"><canvas id="graficoMes"></canvas></div>
      </div>

      <!-- CONTAS -->
      <div id="telaContas" class="hidden">
        <details class="accordion" id="accNovaConta">
          <summary>
            <span>üè¶ Nova conta</span>
            <span class="chev">‚åÑ</span>
          </summary>
          <div class="accBody">
            <div class="row2">
              <div class="field"><label>Nome</label><input id="contaNome"></div>
              <div class="field">
                <label>Tipo</label>
                <select id="contaTipo">
                  <option value="corrente">Corrente</option>
                  <option value="poupanca">Poupan√ßa</option>
                  <option value="cofrinho">Cofrinho</option>
                  <option value="cartao">Cart√£o</option>
                </select>
              </div>
            </div>
            <div class="field"><label>Saldo inicial</label><input id="contaSaldoInicial" type="number" step="0.01" value="0"></div>
            <button class="main" onclick="criarConta()">Criar conta</button>
          </div>
        </details>

        <div class="list" id="listaContas"></div>
      </div>

      <!-- TRANSFER√äNCIAS -->
      <div id="telaTransf" class="hidden">
        <details class="accordion" id="accNovaTransf" open>
          <summary>
            <span>üîÅ Nova transfer√™ncia</span>
            <span class="chev">‚åÑ</span>
          </summary>
          <div class="accBody">
            <div class="row2">
              <div class="field"><label>Origem</label><select id="tOrigem"></select></div>
              <div class="field"><label>Destino</label><select id="tDestino"></select></div>
            </div>

            <div class="row2">
              <div class="field"><label>Valor</label><input id="tValor" type="number" step="0.01"></div>
              <div class="field"><label>Data</label><input id="tData" type="date"></div>
            </div>

            <div class="field"><label>Descri√ß√£o</label><input id="tDesc"></div>
            <button class="main" onclick="criarTransferencia()">Salvar transfer√™ncia</button>
          </div>
        </details>

        <div class="list" id="listaTransf"></div>
      </div>

      <!-- CATEGORIAS (acesso s√≥ pelo ‚öô) -->
      <div id="telaCats" class="hidden">
        <div class="box">
          <h2>Categorias</h2>
          <div class="mini">Voc√™ pode renomear ou excluir (s√≥ exclui se n√£o estiver sendo usada).</div>
          <div class="row2">
            <div class="field">
              <label>Nova categoria</label>
              <input id="catNovaNome" placeholder="Ex: Sa√∫de">
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="main" onclick="criarCategoria()">Adicionar</button>
            </div>
          </div>
          <button class="btnGhost" onclick="showTela('mes')">‚¨Ö Voltar para M√™s</button>
        </div>
        <div class="list" id="listaCats"></div>
      </div>

      <button class="sec" onclick="logout()">Sair</button>
    </div>
  </div>

  <!-- MODAL A√á√ïES -->
  <div id="actionsBack" class="modalBack hidden" onclick="closeActions(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="modalTitle" id="actionsTitle">A√ß√µes</div>
        <button class="modalClose" onclick="closeActions()">X</button>
      </div>
      <div class="modalBody" id="actionsBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAWyMjRVAODIVkC5w95nu9MliqNUMb8ZY",
      authDomain: "controle-financeiro-dffee.firebaseapp.com",
      projectId: "controle-financeiro-dffee",
      storageBucket: "controle-financeiro-dffee.firebasestorage.app",
      messagingSenderId: "470526358884",
      appId: "1:470526358884:web:0dcd3dffb5c0924dadf671"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const mesesNomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    let userId = null;
    let categorias = [];
    let contas = [];
    let dados = [];
    let transferencias = [];
    let grafMes = null;
    let grafAno = null;

    const $ = (id) => document.getElementById(id);

    // ===== Formata√ß√£o BR (milhar + v√≠rgula) =====
    const moneyFmt = new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" });
    function money(v){ return moneyFmt.format(Number(v||0)); }

    // ===== Corrigir bug de data (evitar UTC) =====
    function parseDateLocal(yyyy_mm_dd){
      // espera "YYYY-MM-DD"
      if(!/^\d{4}-\d{2}-\d{2}$/.test(yyyy_mm_dd||"")) return null;
      const [y,m,d] = yyyy_mm_dd.split("-").map(n=>Number(n));
      return { y, m, d, date: new Date(y, m-1, d), mesIndex: (m-1) };
    }

    // ========= UI: telas =========
    const telas = {
      ano: { el: () => $("telaAno"), tab: () => $("tabAno") },
      mes: { el: () => $("telaMes"), tab: () => $("tabMes") },
      contas: { el: () => $("telaContas"), tab: () => $("tabContas") },
      transf: { el: () => $("telaTransf"), tab: () => $("tabTransf") },
      cats: { el: () => $("telaCats"), tab: () => null }, // sem tab
    };

    window.showTela = (nome) => {
      Object.keys(telas).forEach(k=>{
        telas[k].el().classList.toggle("hidden", k !== nome);
        if (telas[k].tab()) telas[k].tab().classList.toggle("active", k === nome);
      });
      if (nome === "mes") renderMes();
      if (nome === "ano") renderAno();
      if (nome === "contas") renderContas();
      if (nome === "transf") renderTransferenciasMes();
      if (nome === "cats") renderCats();
    };

    // ========= Login =========
    window.showCadastro = () => { $("loginScreen").classList.add("hidden"); $("cadastroScreen").classList.remove("hidden"); };
    window.showLogin = () => { $("cadastroScreen").classList.add("hidden"); $("loginScreen").classList.remove("hidden"); };
    window.logout = () => signOut(auth);

    $("btnLogin").onclick = () =>
      signInWithEmailAndPassword(auth, $("emailLogin").value, $("senhaLogin").value)
        .catch(()=>alert("Email ou senha inv√°lidos"));

    $("btnCadastrar").onclick = () => {
      if ($("senhaCad").value !== $("senhaConf").value) return alert("As senhas n√£o conferem");
      createUserWithEmailAndPassword(auth, $("emailCad").value, $("senhaCad").value)
        .catch(()=>alert("Erro ao criar conta"));
    };

    $("btnReset").onclick = () => {
      if(!$("emailLogin").value) return alert("Digite seu email");
      sendPasswordResetEmail(auth, $("emailLogin").value)
        .then(()=>alert("Email enviado"))
        .catch(()=>alert("Erro ao enviar email"));
    };

    $("btnGoogle").onclick = () => signInWithPopup(auth, provider).catch(()=>alert("Erro no login Google"));

    // ========= Modal =========
    window.closeActions = (ev) => {
      if (ev && ev.target && ev.target.id !== "actionsBack") return;
      $("actionsBack").classList.add("hidden");
      $("actionsBody").innerHTML = "";
    };

    function openActions(title, innerHtml){
      $("actionsTitle").innerText = title || "A√ß√µes";
      $("actionsBody").innerHTML = innerHtml;
      $("actionsBack").classList.remove("hidden");
    }
    window.openActions = openActions;

    // ========= Ano / M√™s =========
    function anoAtual(){ return new Date().getFullYear(); }

    function preencherSelectAno(){
      const sel = $("anoSelecionado");
      const current = String(anoAtual());
      const anos = [];
      for (let a=anoAtual()-3; a<=anoAtual()+1; a++) anos.push(String(a));
      sel.innerHTML = "";
      anos.forEach(a=>{
        const o=document.createElement("option");
        o.value=a; o.text=a;
        if (a === current) o.selected = true;
        sel.appendChild(o);
      });
      sel.onchange = async () => {
        await carregarLancamentos();
        await carregarTransferencias();
        renderAno();
        renderMes();
        renderTransferenciasMes();
        renderContas();
      };
    }

    function anoSelecionado(){ return Number($("anoSelecionado").value || anoAtual()); }

    function preencherSelectMes(){
      $("mesSelecionado").innerHTML = "";
      mesesNomes.forEach((m,i)=>{
        const o=document.createElement("option");
        o.value=String(i); o.text=m;
        if(i===new Date().getMonth()) o.selected=true;
        $("mesSelecionado").appendChild(o);
      });
      $("mesSelecionado").onchange = () => { renderMes(); renderTransferenciasMes(); };
    }

    $("data").valueAsDate = new Date();
    $("tData").valueAsDate = new Date();
    $("repete").onchange = () => $("parcelasBox").classList.toggle("hidden", $("repete").value!=="parcelada");

    // ========= Carregamento =========
    async function garantirContaPadrao(){
      const snap = await getDocs(collection(db,"users",userId,"contas"));
      if (snap.size === 0) {
        await addDoc(collection(db,"users",userId,"contas"),{nome:"Conta Padr√£o",tipo:"corrente",saldoInicial:0,criadoEm:new Date()});
      }
    }

    async function carregarContas(){
      contas=[];
      const snap=await getDocs(collection(db,"users",userId,"contas"));
      snap.forEach(d=>contas.push({id:d.id,...d.data()}));
      contas.sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
      preencherSelectContas();
      preencherFiltroContas();
    }

    async function carregarCategorias(){
      categorias=[];
      const snap=await getDocs(collection(db,"users",userId,"categorias"));
      snap.forEach(d=>categorias.push({id:d.id, ...d.data()}));

      if (categorias.length===0){
        for (const c of ["Sal√°rio","Alimenta√ß√£o","Aluguel","Transporte","Lazer"]) {
          await addDoc(collection(db,"users",userId,"categorias"),{nome:c});
        }
        return carregarCategorias();
      }
      categorias.sort((a,b)=>(a.nome||"").localeCompare(b.nome||""));
      preencherSelectCategorias();
    }

    async function migrarAnoSeNecessario(l){
      if (l.ano != null) return;
      const data = l.data || "";
      let ano = anoAtual();
      if (/^\d{4}-\d{2}-\d{2}$/.test(data)) ano = Number(data.slice(0,4));
      await updateDoc(doc(db,"users",userId,"lancamentos",l.id), { ano });
      l.ano = ano;
    }

    async function migrarAnoTransfSeNecessario(t){
      if (t.ano != null) return;
      const data = t.data || "";
      let ano = anoAtual();
      if (/^\d{4}-\d{2}-\d{2}$/.test(data)) ano = Number(data.slice(0,4));
      await updateDoc(doc(db,"users",userId,"transferencias",t.id), { ano });
      t.ano = ano;
    }

    async function carregarLancamentos(){
      dados=[];
      const snap=await getDocs(collection(db,"users",userId,"lancamentos"));
      snap.forEach(d=>dados.push({id:d.id,...d.data()}));
      for (const l of dados) {
        if (l.ano == null) await migrarAnoSeNecessario(l);
      }
    }

    async function carregarTransferencias(){
      transferencias=[];
      const snap=await getDocs(collection(db,"users",userId,"transferencias"));
      snap.forEach(d=>transferencias.push({id:d.id,...d.data()}));
      for (const t of transferencias) {
        if (t.ano == null) await migrarAnoTransfSeNecessario(t);
      }
    }

    function preencherSelectContas(){
      $("contaLanc").innerHTML="";
      $("tOrigem").innerHTML="";
      $("tDestino").innerHTML="";
      contas.forEach(c=>{
        const o=document.createElement("option");
        o.value=c.id; o.text=`${c.nome} (${c.tipo})`;
        $("contaLanc").appendChild(o);

        const o1=document.createElement("option");
        o1.value=c.id; o1.text=c.nome;
        $("tOrigem").appendChild(o1);
        $("tDestino").appendChild(o1.cloneNode(true));
      });
    }

    function preencherFiltroContas(){
      const sel=$("fConta");
      const atual=sel.value || "todas";
      sel.innerHTML=`<option value="todas">Todas as contas</option>`;
      contas.forEach(c=>{
        const o=document.createElement("option");
        o.value=c.id; o.text=c.nome;
        sel.appendChild(o);
      });
      sel.value = Array.from(sel.options).some(o=>o.value===atual) ? atual : "todas";
      $("fStatus").onchange = renderMes;
      $("fBusca").oninput = renderMes;
      $("fConta").onchange = renderMes;
      $("fTipoLanc").onchange = renderMes;

    }

    function preencherSelectCategorias(){
      $("categoria").innerHTML='<option value="">Selecione</option>';
      categorias.forEach(c=>{
        const o=document.createElement("option");
        o.value=c.nome; o.text=c.nome;
        $("categoria").appendChild(o);
      });
    }

    async function carregarTudo(){
      await garantirContaPadrao();
      await carregarContas();
      await carregarCategorias();
      await carregarLancamentos();
      await carregarTransferencias();
      renderAno();
      renderMes();
      renderContas();
      renderTransferenciasMes();
      renderCats();
    }

    // ========= Helpers =========
    function nomeConta(id){
      const c=contas.find(x=>x.id===id);
      return c ? c.nome : "Conta";
    }

    function saldoConta(contaId){
      const conta=contas.find(c=>c.id===contaId);
      let saldo=Number(conta?.saldoInicial||0);

      const ano = anoSelecionado();

      for(const l of dados){
        if (Number(l.ano ?? ano) !== ano) continue;
        const lConta=l.contaId||contas[0]?.id;
        if(l.status!=="pago") continue;
        if(lConta!==contaId) continue;
        if(l.tipo==="receita") saldo += Number(l.valor||0);
        if(l.tipo==="despesa") saldo -= Number(l.valor||0);
      }
      for(const t of transferencias){
        if (Number(t.ano ?? ano) !== ano) continue;
        if(t.status!=="confirmada") continue;
        if(t.origemId===contaId) saldo -= Number(t.valor||0);
        if(t.destinoId===contaId) saldo += Number(t.valor||0);
      }
      return saldo;
    }

    function saldoTotalTodasContas(){
      return contas.reduce((acc,c)=>acc+saldoConta(c.id),0);
    }

    // ========= Categorias =========
    window.criarCategoria = async () => {
      const nome = ($("catNovaNome").value || "").trim();
      if (!nome) return alert("Digite o nome da categoria.");
      await addDoc(collection(db,"users",userId,"categorias"),{nome});
      $("catNovaNome").value="";
      await carregarCategorias();
      renderCats();
    };

    window.renomearCategoria = async (catId) => {
      const c = categorias.find(x=>x.id===catId);
      if (!c) return;
      const novo = prompt("Novo nome da categoria:", c.nome);
      if (novo === null) return;
      const nome = novo.trim();
      if (!nome) return alert("Nome inv√°lido.");

      await updateDoc(doc(db,"users",userId,"categorias",catId), { nome });

      if (confirm("Deseja atualizar os lan√ßamentos que usam esta categoria?")) {
        const antigos = dados.filter(l => l.cat === c.nome);
        for (const l of antigos) {
          await updateDoc(doc(db,"users",userId,"lancamentos",l.id), { cat: nome });
        }
      }

      await carregarCategorias();
      await carregarLancamentos();
      renderCats();
      renderMes();
      renderAno();
    };

    window.excluirCategoria = async (catId) => {
      const c = categorias.find(x=>x.id===catId);
      if (!c) return;
      const emUso = dados.some(l => l.cat === c.nome);
      if (emUso) return alert("N√£o posso excluir: essa categoria est√° sendo usada em lan√ßamentos. Renomeie ou altere os lan√ßamentos primeiro.");
      if (!confirm(`Excluir a categoria "${c.nome}"?`)) return;
      await deleteDoc(doc(db,"users",userId,"categorias",catId));
      await carregarCategorias();
      renderCats();
      renderMes();
    };

    // ========= Contas =========
    window.criarConta = async () => {
      const nome=($("contaNome").value||"").trim();
      if(!nome) return alert("Digite o nome.");
      const tipo=$("contaTipo").value;
      const saldoInicial=Number($("contaSaldoInicial").value||0);
      if(!Number.isFinite(saldoInicial)) return alert("Saldo inv√°lido.");
      await addDoc(collection(db,"users",userId,"contas"),{nome,tipo,saldoInicial,criadoEm:new Date()});
      $("contaNome").value=""; $("contaSaldoInicial").value="0";
      await carregarContas();
      renderContas();
      renderAno();
      renderMes();
    };

    function abrirEditarConta(contaId){
      const c = contas.find(x=>x.id===contaId);
      if(!c) return;
      openActions("Editar conta", `
        <div class="field"><label>Nome</label><input id="edContaNome" value="${escapeHtml(c.nome||"")}"></div>
        <div class="field">
          <label>Tipo</label>
          <select id="edContaTipo">
            <option ${c.tipo==="corrente"?"selected":""} value="corrente">Corrente</option>
            <option ${c.tipo==="poupanca"?"selected":""} value="poupanca">Poupan√ßa</option>
            <option ${c.tipo==="cofrinho"?"selected":""} value="cofrinho">Cofrinho</option>
            <option ${c.tipo==="cartao"?"selected":""} value="cartao">Cart√£o</option>
          </select>
        </div>
        <div class="field"><label>Saldo inicial</label><input id="edContaSaldo" type="number" step="0.01" value="${Number(c.saldoInicial||0)}"></div>

        <button class="modalBtn ok" onclick="salvarEdConta('${c.id}')">üíæ Salvar</button>
        <button class="modalBtn del" onclick="excluirConta('${c.id}')">üóë Excluir conta</button>
      `);
    }

    window.salvarEdConta = async (contaId) => {
      const nome = ($("edContaNome").value||"").trim();
      const tipo = $("edContaTipo").value;
      const saldoInicial = Number($("edContaSaldo").value||0);
      if(!nome) return alert("Nome inv√°lido.");
      if(!Number.isFinite(saldoInicial)) return alert("Saldo inv√°lido.");
      await updateDoc(doc(db,"users",userId,"contas",contaId), { nome, tipo, saldoInicial });
      closeActions();
      await carregarContas();
      renderContas();
      renderAno();
      renderMes();
    };

    window.excluirConta = async (contaId) => {
      const c=contas.find(x=>x.id===contaId);
      if(!c) return;
      if((c.nome||"").toLowerCase().includes("padr√£o")) return alert("Conta Padr√£o n√£o pode ser exclu√≠da.");

      const temLanc=dados.some(l=>(l.contaId||contas[0]?.id)===contaId);
      const temTransf=transferencias.some(t=>t.origemId===contaId||t.destinoId===contaId);
      if(temLanc||temTransf) return alert("Conta em uso. Remova/edite lan√ßamentos e transfer√™ncias antes.");
      if(!confirm(`Excluir a conta "${c.nome}"?`)) return;
      await deleteDoc(doc(db,"users",userId,"contas",contaId));
      closeActions();
      await carregarContas();
      renderContas();
      renderAno();
      renderMes();
    };

    // ========= Lan√ßamentos =========
    window.adicionarLancamento = async () => {
      if(!$("tipo").value||!$("categoria").value||!$("valor").value||!$("data").value||!$("repete").value) return alert("Preencha tudo.");

      const contaId=$("contaLanc").value || (contas[0]?.id ?? null);
      const valorTotal=Number($("valor").value);
      if(!Number.isFinite(valorTotal) || valorTotal<=0) return alert("Valor inv√°lido.");

      const dataStr=$("data").value;
      const p = parseDateLocal(dataStr);
      if(!p) return alert("Data inv√°lida.");

      const mesBase=p.mesIndex;
      const ano = p.y;

      const grupo=String(Date.now())+"_"+Math.floor(Math.random()*1e6);
      const statusNovo = $("statusNovo").value || "pendente";

      const base={
        tipo:$("tipo").value,
        cat:$("categoria").value,
        desc:$("desc").value||"",
        mes:mesBase,
        data:dataStr,
        ano,
        grupo,
        status:statusNovo,
        contaId
      };

      const salvar = (o)=>addDoc(collection(db,"users",userId,"lancamentos"),o);

      if($("repete").value==="fixa"){
        for(let m=mesBase;m<12;m++) await salvar({...base,mes:m,valor:valorTotal,fixed:true});
      } else if($("repete").value==="parcelada"){
        const parc=Number($("parcelas").value||2);
        const vp=valorTotal/parc;
        for(let i=0;i<parc;i++){
          const m = (mesBase+i)%12;
          // mant√©m o ano correto (se passar de dezembro, soma ano)
          const y = ano + Math.floor((mesBase+i)/12);
          await salvar({...base,mes:m,ano:y,valor:vp,parcela:i+1,total:parc});
        }
      } else {
        await salvar({...base,valor:valorTotal});
      }

      $("desc").value="";
      $("valor").value="";
      $("repete").value="";
      $("parcelas").value=2;
      $("statusNovo").value="pendente";
      $("parcelasBox").classList.add("hidden");
      $("accNovoLanc").open = false;

      await carregarLancamentos();
      renderMes();
      renderAno();
      renderContas();
    };

    window.pagar = async (id)=>{
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pago"});
      await carregarLancamentos(); renderMes(); renderAno(); renderContas();
    };
    window.voltar = async (id)=>{
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pendente"});
      await carregarLancamentos(); renderMes(); renderAno(); renderContas();
    };

    function abrirEditarLanc(lancId){
      const l = dados.find(x=>x.id===lancId);
      if(!l) return;

      const contasOpt = contas.map(c=>`<option value="${c.id}" ${((l.contaId||contas[0]?.id)===c.id)?"selected":""}>${escapeHtml(c.nome)} (${escapeHtml(c.tipo)})</option>`).join("");
      const catsOpt = categorias.map(c=>`<option value="${escapeHtml(c.nome)}" ${(l.cat===c.nome)?"selected":""}>${escapeHtml(c.nome)}</option>`).join("");

      openActions("Editar lan√ßamento", `
        <div class="row2">
          <div class="field">
            <label>Tipo</label>
            <select id="edLTp">
              <option value="receita" ${l.tipo==="receita"?"selected":""}>Receita</option>
              <option value="despesa" ${l.tipo==="despesa"?"selected":""}>Despesa</option>
            </select>
          </div>
          <div class="field">
            <label>Status</label>
            <select id="edLSt">
              <option value="pendente" ${l.status==="pendente"?"selected":""}>Pendente</option>
              <option value="pago" ${l.status==="pago"?"selected":""}>Pago</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Conta</label>
          <select id="edLCt">${contasOpt}</select>
        </div>

        <div class="field">
          <label>Categoria</label>
          <select id="edLCat">${catsOpt}</select>
        </div>

        <div class="field"><label>Descri√ß√£o</label><input id="edLDesc" value="${escapeHtml(l.desc||"")}"></div>

        <div class="row2">
          <div class="field"><label>Valor</label><input id="edLV" type="number" step="0.01" value="${Number(l.valor||0)}"></div>
          <div class="field"><label>Data</label><input id="edLData" type="date" value="${escapeHtml(l.data||"")}"></div>
        </div>

        <div class="mini">Obs: editar data muda m√™s/ano automaticamente.</div>

        <button class="modalBtn ok" onclick="salvarEdLanc('${l.id}')">üíæ Salvar</button>
        <button class="modalBtn del" onclick="excluirLancComFuturos('${l.id}')">üóë Excluir (este e futuros pendentes)</button>
      `);
    }

    window.salvarEdLanc = async (lancId) => {
      const tipo = $("edLTp").value;
      const status = $("edLSt").value;
      const contaId = $("edLCt").value;
      const cat = $("edLCat").value;
      const desc = $("edLDesc").value || "";
      const valor = Number($("edLV").value||0);
      const data = $("edLData").value;

      if(!cat) return alert("Categoria inv√°lida.");
      if(!data) return alert("Data inv√°lida.");
      if(!Number.isFinite(valor) || valor<=0) return alert("Valor inv√°lido.");

      const p = parseDateLocal(data);
      if(!p) return alert("Data inv√°lida.");
      const mes = p.mesIndex;
      const ano = p.y;

      await updateDoc(doc(db,"users",userId,"lancamentos",lancId), { tipo, status, contaId, cat, desc, valor, data, mes, ano });

      closeActions();
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    window.excluirLancComFuturos = async (id) => {
      const item=dados.find(x=>x.id===id);
      if(!item) return;
      if(!confirm("Excluir este lan√ßamento e todos os futuros pendentes do mesmo grupo?")) return;

      const grupo=item.grupo;
      const mesAtual=Number(item.mes);
      const ano = Number(item.ano ?? anoSelecionado());

      const q=query(collection(db,"users",userId,"lancamentos"), where("grupo","==",grupo));
      const snap=await getDocs(q);

      for(const d of snap.docs){
        const v=d.data();
        const docId=d.id;

        const vAno = Number(v.ano ?? ano);
        const vMes = Number(v.mes ?? 0);

        const isThis=(docId===id);
        const isFuturePending=(v.status==="pendente" && vAno===ano && vMes>=mesAtual);
        if(isThis || isFuturePending) await deleteDoc(d.ref);
      }

      closeActions();
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    // ========= Transfer√™ncias =========
    window.criarTransferencia = async () => {
      const origemId=$("tOrigem").value;
      const destinoId=$("tDestino").value;
      const valor=Number($("tValor").value||0);
      const dataStr=$("tData").value;
      const desc=($("tDesc").value||"").trim();

      if(!origemId||!destinoId) return alert("Selecione origem e destino.");
      if(origemId===destinoId) return alert("Origem e destino devem ser diferentes.");
      if(!Number.isFinite(valor)||valor<=0) return alert("Valor inv√°lido.");
      if(!dataStr) return alert("Informe a data.");

      const p = parseDateLocal(dataStr);
      if(!p) return alert("Data inv√°lida.");

      const mes=p.mesIndex;
      const ano=p.y;

      await addDoc(collection(db,"users",userId,"transferencias"),{origemId,destinoId,valor,data:dataStr,mes,ano,desc,status:"confirmada",criadoEm:new Date()});
      $("tValor").value=""; $("tDesc").value="";
      $("accNovaTransf").open = false;

      await carregarTransferencias();
      renderTransferenciasMes(); renderAno(); renderMes(); renderContas();
    };

    function abrirEditarTransf(id){
      const t=transferencias.find(x=>x.id===id);
      if(!t) return;

      const contasOptO = contas.map(c=>`<option value="${c.id}" ${t.origemId===c.id?"selected":""}>${escapeHtml(c.nome)}</option>`).join("");
      const contasOptD = contas.map(c=>`<option value="${c.id}" ${t.destinoId===c.id?"selected":""}>${escapeHtml(c.nome)}</option>`).join("");

      openActions("Editar transfer√™ncia", `
        <div class="row2">
          <div class="field"><label>Origem</label><select id="edTO">${contasOptO}</select></div>
          <div class="field"><label>Destino</label><select id="edTD">${contasOptD}</select></div>
        </div>
        <div class="row2">
          <div class="field"><label>Valor</label><input id="edTV" type="number" step="0.01" value="${Number(t.valor||0)}"></div>
          <div class="field"><label>Data</label><input id="edTData" type="date" value="${escapeHtml(t.data||"")}"></div>
        </div>
        <div class="field"><label>Descri√ß√£o</label><input id="edTDesc" value="${escapeHtml(t.desc||"")}"></div>
        <button class="modalBtn ok" onclick="salvarEdTransf('${t.id}')">üíæ Salvar</button>
        <button class="modalBtn del" onclick="excluirTransf('${t.id}')">üóë Excluir</button>
      `);
    }

    window.salvarEdTransf = async (id) => {
      const origemId = $("edTO").value;
      const destinoId = $("edTD").value;
      const valor = Number($("edTV").value||0);
      const data = $("edTData").value;
      const desc = $("edTDesc").value||"";

      if(origemId===destinoId) return alert("Origem e destino precisam ser diferentes.");
      if(!Number.isFinite(valor) || valor<=0) return alert("Valor inv√°lido.");
      if(!data) return alert("Data inv√°lida.");

      const p = parseDateLocal(data);
      if(!p) return alert("Data inv√°lida.");

      const mes = p.mesIndex;
      const ano = p.y;

      await updateDoc(doc(db,"users",userId,"transferencias",id), { origemId, destinoId, valor, data, mes, ano, desc });

      closeActions();
      await carregarTransferencias();
      renderTransferenciasMes(); renderAno(); renderMes(); renderContas();
    };

    window.excluirTransf = async (id) => {
      if(!confirm("Excluir esta transfer√™ncia?")) return;
      await deleteDoc(doc(db,"users",userId,"transferencias",id));
      closeActions();
      await carregarTransferencias();
      renderTransferenciasMes(); renderAno(); renderMes(); renderContas();
    };

    // ========= Filtros =========
    window.limparFiltros = () => {
      $("fConta").value = "todas";
      $("fStatus").value = "todos";
      $("fTipoLanc").value = "todos";
      $("fBusca").value = "";
      $("accFiltros").open = false;
      renderMes();
    };

    window.abrirGerenciarCategorias = () => showTela("cats");

    // ========= Renders =========
    window.renderAno = () => {
      const ano = anoSelecionado();
      let rM=Array(12).fill(0), dM=Array(12).fill(0), r=0, d=0;

      for(const i of dados){
        if (Number(i.ano ?? ano) !== ano) continue;
        if(i.status!=="pago") continue;
        const m=Number(i.mes ?? 0);
        if(i.tipo==="receita"){ r+=Number(i.valor||0); rM[m]+=Number(i.valor||0); }
        else { d+=Number(i.valor||0); dM[m]+=Number(i.valor||0); }
      }

      $("rAno").innerText=money(r);
      $("dAno").innerText=money(d);
      $("sAno").innerText=money(r-d);
      $("saldoTotal").innerText=money(saldoTotalTodasContas());

      if(!grafAno){
        grafAno=new Chart($("graficoAno"),{type:"bar",data:{labels:mesesNomes,datasets:[
          {label:"Receitas",data:[],backgroundColor:"#22c55e"},
          {label:"Despesas",data:[],backgroundColor:"#ef4444"}
        ]}});
      }
      grafAno.data.datasets[0].data=rM;
      grafAno.data.datasets[1].data=dM;
      grafAno.update();
    };

    function renderListaLancamentos(containerEl, lista){
      containerEl.innerHTML = "";

      if(lista.length===0){
        containerEl.innerHTML = `<div class="mini">Sem itens.</div>`;
        return;
      }

      for(const i of lista){
        const statusTxt=(i.status==="pago")?"Pago":"Pendente";
        const contaNome=nomeConta(i.contaId||contas[0]?.id);

        let info=i.desc||"";
        if(i.parcela) info+=` (${i.parcela}/${i.total})`;
        if(i.fixed) info+=" (Fixa)";

        const dataVis = i.data ? i.data.split("-").reverse().join("/") : "";

        const div=document.createElement("div");
        div.className="tx";
        div.innerHTML=`
          <div>
            <div class="title">${escapeHtml(i.cat||"")}</div>
            <div class="meta">${escapeHtml(dataVis)} ‚Ä¢ ${escapeHtml(info)} ‚Ä¢ ${escapeHtml(contaNome)} ‚Ä¢ ${statusTxt}</div>
          </div>
          <div class="right">
            <div class="amount ${i.tipo==='receita'?'rec':'desp'}">${money(i.valor)}</div>

            ${
              i.status==="pendente"
                ? `<button class="iconBtn pending" onclick="pagar('${i.id}')" title="Marcar como pago">‚è≥</button>`
                : `<button class="iconBtn paid" onclick="voltar('${i.id}')" title="Voltar para pendente">‚úî</button>`
            }

            <button class="iconBtn" onclick="abrirEditarLanc('${i.id}')" title="Editar">...</button>
          </div>
        `;
        containerEl.appendChild(div);
      }
    }

    window.renderMes = () => {
      const ano = anoSelecionado();
      const mes = Number($("mesSelecionado").value);

      let r=0,d=0;
      const cat={};

      const itensMes = dados.filter(i => Number(i.ano ?? ano) === ano && Number(i.mes) === mes);

      for(const i of itensMes){
        if(i.status==="pago"){
          if(i.tipo==="receita") r+=Number(i.valor||0);
          else d+=Number(i.valor||0);
          if(i.tipo==="despesa") cat[i.cat]=(cat[i.cat]||0)+Number(i.valor||0);
        }
      }

      $("rMes").innerText=money(r);
      $("dMes").innerText=money(d);
      $("sMes").innerText=money(r-d);

           // aplica filtros
      const fConta=$("fConta").value;
      const fStatus=$("fStatus").value;
      const fBusca=($("fBusca").value||"").trim().toLowerCase();
      const fTipoLanc = ($("fTipoLanc")?.value || "todos");

      let lista = itensMes.slice();


      if(fConta!=="todas") lista = lista.filter(i=>(i.contaId||contas[0]?.id)===fConta);
      if(fStatus!=="todos") lista = lista.filter(i=>i.status===fStatus);
      if(fBusca) lista = lista.filter(i=>String(i.cat||"").toLowerCase().includes(fBusca)||String(i.desc||"").toLowerCase().includes(fBusca));

            // filtra por tipo de lan√ßamento (√önica/Fixa/Parcelada)
      if (fTipoLanc !== "todos") {
        lista = lista.filter(i => {
          const isFixa = !!i.fixed;
          const isParcelada = !!i.parcela;
          const isUnica = !isFixa && !isParcelada;

          if (fTipoLanc === "fixa") return isFixa;
          if (fTipoLanc === "parcelada") return isParcelada;
          if (fTipoLanc === "unica") return isUnica;
          return true;
        });
      }

      // ordena por data (string YYYY-MM-DD funciona bem)
      lista.sort((a,b)=>String(a.data||"").localeCompare(String(b.data||"")));

      // separa em 2 colunas
      const receitas = lista.filter(x=>x.tipo==="receita");
      const despesas = lista.filter(x=>x.tipo==="despesa");

      renderListaLancamentos($("listaReceitas"), receitas);
      renderListaLancamentos($("listaDespesas"), despesas);

      if(!grafMes){
        grafMes=new Chart($("graficoMes"),{type:"pie",data:{labels:[],datasets:[{data:[],backgroundColor:["#22c55e","#3b82f6","#f59e0b","#ef4444","#a855f7","#14b8a6"]}]}} );
      }
      grafMes.data.labels=Object.keys(cat);
      grafMes.data.datasets[0].data=Object.values(cat);
      grafMes.update();

      renderTransferenciasMes();
    };

    window.renderContas = () => {
      $("listaContas").innerHTML = `
        <h2>Contas</h2>
        <div class="mini">Saldos calculados no ano selecionado: <b>${anoSelecionado()}</b></div>
        <div class="accountsGrid" id="accGrid"></div>
      `;
      const grid = $("accGrid");
      grid.innerHTML = "";

      contas.forEach(c=>{
        const saldo = saldoConta(c.id);
        const posNeg = saldo>=0 ? "pos" : "neg";
        const div=document.createElement("div");
        div.className="acc";
        div.innerHTML=`
          <div>
            <div class="name">${escapeHtml(c.nome||"")}</div>
            <div class="type">${escapeHtml(c.tipo||"")} ‚Ä¢ saldo inicial: ${money(c.saldoInicial||0)}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:flex-start;">
            <div class="bal ${posNeg}">${money(saldo)}</div>
            <button class="iconBtn" onclick="abrirEditarConta('${c.id}')" title="Editar conta">...</button>
          </div>
        `;
        grid.appendChild(div);
      });
    };

    window.renderTransferenciasMes = () => {
      const ano = anoSelecionado();
      const mes=Number($("mesSelecionado").value);

      $("listaTransf").innerHTML="<h2>Transfer√™ncias do m√™s</h2>";

      const itens=transferencias
        .filter(t => Number(t.ano ?? ano) === ano && Number(t.mes)===mes)
        .sort((a,b)=>String(a.data||"").localeCompare(String(b.data||"")));

      if(itens.length===0){
        $("listaTransf").innerHTML += `<div class="mini">Nenhuma transfer√™ncia neste m√™s.</div>`;
        return;
      }

      itens.forEach(t=>{
        const dataVis = t.data ? t.data.split("-").reverse().join("/") : "";
        const div=document.createElement("div");
        div.className="tr";
        div.innerHTML=`
          <div>
            <div class="title">${escapeHtml(nomeConta(t.origemId))} ‚Üí ${escapeHtml(nomeConta(t.destinoId))}</div>
            <div class="meta">${escapeHtml(t.desc||"")} ‚Ä¢ ${escapeHtml(dataVis)}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="val">${money(t.valor)}</div>
            <button class="iconBtn" onclick="abrirEditarTransf('${t.id}')" title="Editar transfer√™ncia">...</button>
          </div>
        `;
        $("listaTransf").appendChild(div);
      });
    };

    window.renderCats = () => {
      $("listaCats").innerHTML = "<h2>Lista de categorias</h2>";
      categorias.forEach(c=>{
        const div=document.createElement("div");
        div.className="tx";
        div.innerHTML=`
          <div>
            <div class="title">${escapeHtml(c.nome||"")}</div>
            <div class="meta">Gerenciar categoria</div>
          </div>
          <div class="right">
            <button class="iconBtn" onclick="renomearCategoria('${c.id}')" title="Renomear">...</button>
            <button class="iconBtn" onclick="excluirCategoria('${c.id}')" title="Excluir">üóë</button>
          </div>
        `;
        $("listaCats").appendChild(div);
      });
    };

    // ========= Escape helper =========
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ========= Auth =========
    onAuthStateChanged(auth, async (u)=>{
      $("actionsBack").classList.add("hidden");

      if(u){
        userId=u.uid;
        $("loginScreen").classList.add("hidden");
        $("cadastroScreen").classList.add("hidden");
        $("appScreen").classList.remove("hidden");

        preencherSelectAno();
        preencherSelectMes();

        await carregarTudo();

        showTela("ano");
      }else{
        $("appScreen").classList.add("hidden");
        showLogin();
      }
    });

    // Expor fun√ß√µes usadas no HTML
    window.abrirEditarConta = abrirEditarConta;
    window.abrirEditarLanc = abrirEditarLanc;
    window.abrirEditarTransf = abrirEditarTransf;
  </script>
</body>
</html>

