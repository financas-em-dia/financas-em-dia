<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finan√ßas em Dia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1:#020617;
      --bg2:#0b1224;
      --card: rgba(255,255,255,0.05);
      --card2: rgba(255,255,255,0.07);
      --border: rgba(148,163,184,0.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --blue:#3b82f6;
      --shadow: 0 10px 35px rgba(0,0,0,0.35);
    }

    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    body{
      margin:0;
      background: radial-gradient(1200px 500px at 10% -10%, rgba(34,197,94,0.18), transparent 60%),
                  radial-gradient(900px 500px at 110% 0%, rgba(59,130,246,0.16), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      padding:14px;
    }

    .container{max-width:560px;margin:auto;}
    h1{text-align:center;margin:10px 0 12px;font-size:1.35rem;letter-spacing:.2px;}
    h2{margin:0 0 10px 0;font-size:1.05rem;}
    .hidden{display:none;}
    button{cursor:pointer}

    .box,.form,.list,.chart-box{
      margin-top:14px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .field{margin-bottom:10px;}
    label{font-size:.78rem;color:var(--muted);display:block;margin-bottom:6px;}

    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(2,6,23,0.45);
      color: var(--text);
      outline:none;
    }
    input:focus,select:focus{
      border-color: rgba(34,197,94,0.55);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.12);
    }
    input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);opacity:.85;}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

    .top-tabs{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .top-tabs button{
      flex:1;
      min-width:120px;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:800;
      transition: transform .08s ease, background .2s ease;
    }
    .top-tabs button:hover{transform: translateY(-1px);}
    .top-tabs button.active{
      background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(22,163,74,0.95));
      color:#052e16;
      border-color: transparent;
    }

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;}
    .card{
      background: var(--card2);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
    }
    .card.saldo{grid-column:1/3;text-align:center;}
    .card h3{font-size:.78rem;color:var(--muted);margin:0 0 8px;}
    .card .value{font-size:1.25rem;font-weight:900;letter-spacing:.2px;}
    .card .sub{font-size:.78rem;color:var(--muted);margin-top:4px}

    button.main{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      color:#052e16;
      font-weight:950;
    }
    button.sec{
      width:100%;
      padding:11px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:800;
      margin-top:8px;
    }
    .plus{
      width:44px;margin-left:8px;padding:10px;border-radius:14px;
      background: rgba(34,197,94,1);border:none;color:#052e16;font-weight:950;
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:.78rem;
      color: var(--muted);
    }
    .mini{font-size:.78rem;color:var(--muted);line-height:1.35}

    /* LAN√áAMENTOS */
    .tx{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(148,163,184,0.14);
    }
    .tx:last-child{border-bottom:none;}
    .tx .title{font-weight:900;font-size:.93rem}
    .tx .meta{font-size:.78rem;color:var(--muted);margin-top:2px}
    .tx .right{display:flex;align-items:center;gap:10px;}

    .amount{
      font-weight:950;
      min-width:115px;
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .amount.rec{color:var(--primary);}
    .amount.desp{color:var(--danger);}

    .iconBtn{
      width:44px;height:40px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:hover{background: rgba(255,255,255,0.07);}
    .iconBtn.ok{border-color: rgba(34,197,94,0.45); color: var(--primary);}
    .iconBtn.undo{border-color: rgba(59,130,246,0.45); color: var(--blue);}

    /* CONTAS */
    .accountsGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .acc{
      background: var(--card2);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .acc .name{font-weight:950}
    .acc .type{font-size:.78rem;color:var(--muted);margin-top:2px}
    .acc .bal{font-weight:1000;font-size:1.18rem;font-variant-numeric: tabular-nums;}
    .acc .bal.pos{color:var(--primary);}
    .acc .bal.neg{color:var(--danger);}

    /* TRANSFER√äNCIAS */
    .tr{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(148,163,184,0.14);
    }
    .tr:last-child{border-bottom:none;}
    .tr .title{font-weight:900;font-size:.92rem}
    .tr .meta{font-size:.78rem;color:var(--muted);margin-top:2px}
    .tr .val{font-weight:950;min-width:115px;text-align:right;font-variant-numeric: tabular-nums;}

    /* MODAL A√á√ïES (sempre acima do gr√°fico) */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index: 999999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .modal{
      width:100%;
      max-width:560px;
      background: rgba(2,6,23,0.95);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid rgba(148,163,184,0.14);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .modalTitle{
      font-weight:950;
      font-size:.95rem;
      color: var(--text);
    }
    .modalClose{
      width:42px;height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
    }
    .modalBody{padding:10px 14px;}
    .modalBtn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-weight:900;
      text-align:left;
      margin-bottom:10px;
    }
    .modalBtn:hover{background: rgba(255,255,255,0.07);}
    .modalBtn.edit{border-color: rgba(245,158,11,0.35); color: var(--warn);}
    .modalBtn.del{border-color: rgba(239,68,68,0.35); color: var(--danger);}

    .chart-box{ overflow: visible; }
  </style>
</head>

<body>
  <div class="container">

    <!-- LOGIN -->
    <div id="loginScreen">
      <h1>üîê Finan√ßas em Dia</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailLogin" type="email" autocomplete="email"></div>
        <div class="field"><label>Senha</label><input id="senhaLogin" type="password" autocomplete="current-password"></div>
        <button class="main" id="btnLogin">Entrar</button>
        <button class="sec" onclick="showCadastro()">Primeiro acesso</button>
        <button class="sec" id="btnReset">Esqueci minha senha</button>
        <hr style="margin:14px 0;border-color:rgba(148,163,184,0.25)">
        <button class="main" id="btnGoogle">Entrar com Google</button>
      </div>
    </div>

    <!-- CADASTRO -->
    <div id="cadastroScreen" class="hidden">
      <h1>üìù Criar Conta</h1>
      <div class="box">
        <div class="field"><label>Email</label><input id="emailCad" type="email" autocomplete="email"></div>
        <div class="field"><label>Senha</label><input id="senhaCad" type="password" autocomplete="new-password"></div>
        <div class="field"><label>Confirmar Senha</label><input id="senhaConf" type="password" autocomplete="new-password"></div>
        <button class="main" id="btnCadastrar">Cadastrar</button>
        <button class="sec" onclick="showLogin()">Voltar</button>
      </div>
    </div>

    <!-- APP -->
    <div id="appScreen" class="hidden">
      <h1>üí∞ Finan√ßas em Dia</h1>

      <div class="top-tabs">
        <button id="tabMes" class="active" onclick="showTela('mes')">M√™s</button>
        <button id="tabAno" onclick="showTela('ano')">Resumo Anual</button>
        <button id="tabContas" onclick="showTela('contas')">Contas</button>
        <button id="tabTransf" onclick="showTela('transf')">Transfer√™ncias</button>
      </div>

      <!-- TELA M√äS -->
      <div id="telaMes">
        <div class="box">
          <div class="field">
            <label>M√™s</label>
            <select id="mesSelecionado" onchange="renderMes()"></select>
          </div>

          <div class="row3">
            <div class="field">
              <label>Filtrar por conta</label>
              <select id="fConta" onchange="renderMes()"></select>
            </div>
            <div class="field">
              <label>Status</label>
              <select id="fStatus" onchange="renderMes()">
                <option value="todos">Todos</option>
                <option value="pendente">Pendente</option>
                <option value="pago">Pago</option>
              </select>
            </div>
            <div class="field">
              <label>Buscar</label>
              <input id="fBusca" placeholder="categoria ou descri√ß√£o" oninput="renderMes()">
            </div>
          </div>

          <div class="mini">
            <span class="pill">Dica</span>
            Filtros s√≥ afetam a lista. Os totais do m√™s continuam considerando <b>pagos</b>.
          </div>
        </div>

        <div class="cards">
          <div class="card"><h3>Receitas Pagas</h3><div class="value" id="rMes">R$0</div></div>
          <div class="card"><h3>Despesas Pagas</h3><div class="value" id="dMes">R$0</div></div>
          <div class="card saldo"><h3>Saldo do M√™s</h3><div class="value" id="sMes">R$0</div><div class="sub">Receitas - Despesas (pagas)</div></div>
        </div>

        <div class="form">
          <h2>Novo Lan√ßamento</h2>

          <div class="row2">
            <div class="field">
              <label>Tipo</label>
              <select id="tipo">
                <option value="">Selecione</option>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>

            <div class="field">
              <label>Conta</label>
              <select id="contaLanc"></select>
            </div>
          </div>

          <div class="field">
            <label>Categoria</label>
            <div style="display:flex;align-items:center;">
              <select id="categoria"></select>
              <button class="plus" onclick="novaCategoria()" title="Nova categoria">+</button>
            </div>
          </div>

          <div class="field"><label>Descri√ß√£o</label><input id="desc" placeholder="Ex: Mercado, aluguel, sal√°rio..."/></div>

          <div class="row2">
            <div class="field"><label>Valor (TOTAL)</label><input id="valor" type="number" step="0.01" placeholder="0,00"/></div>
            <div class="field"><label>Data</label><input id="data" type="date"/></div>
          </div>

          <div class="row2">
            <div class="field">
              <label>Tipo de Lan√ßamento</label>
              <select id="repete">
                <option value="">Selecione</option>
                <option value="variavel">√önica</option>
                <option value="fixa">Fixa</option>
                <option value="parcelada">Parcelada</option>
              </select>
            </div>

            <div class="field hidden" id="parcelasBox">
              <label>Parcelas</label>
              <input id="parcelas" type="number" value="2" min="2"/>
            </div>
          </div>

          <button class="main" onclick="adicionarLancamento()" style="margin-top:10px;">Adicionar</button>
        </div>

        <div class="list" id="listaMes"></div>
        <div class="chart-box"><canvas id="graficoMes"></canvas></div>
      </div>

      <!-- TELA ANO -->
      <div id="telaAno" class="hidden">
        <div class="cards">
          <div class="card"><h3>Receitas Ano</h3><div class="value" id="rAno">R$0</div></div>
          <div class="card"><h3>Despesas Ano</h3><div class="value" id="dAno">R$0</div></div>
          <div class="card saldo"><h3>Saldo Ano</h3><div class="value" id="sAno">R$0</div><div class="sub">Somente lan√ßamentos pagos</div></div>
        </div>

        <div class="box">
          <h2>Saldo Total (todas as contas)</h2>
          <div class="mini">Soma dos saldos atuais de todas as contas.</div>
          <div class="card" style="margin-top:10px;">
            <h3>Saldo Total</h3>
            <div class="value" id="saldoTotal">R$0</div>
          </div>
        </div>

        <div class="chart-box"><canvas id="graficoAno"></canvas></div>
      </div>

      <!-- TELA CONTAS -->
      <div id="telaContas" class="hidden">
        <div class="box">
          <h2>Minhas Contas</h2>

          <div class="row2">
            <div class="field"><label>Nome</label><input id="contaNome" placeholder="Ex: Ita√∫ Casa"></div>
            <div class="field">
              <label>Tipo</label>
              <select id="contaTipo">
                <option value="corrente">Corrente</option>
                <option value="poupanca">Poupan√ßa</option>
                <option value="cofrinho">Cofrinho</option>
                <option value="cartao">Cart√£o</option>
              </select>
            </div>
          </div>

          <div class="field"><label>Saldo inicial</label><input id="contaSaldoInicial" type="number" step="0.01" value="0"></div>
          <button class="main" onclick="criarConta()">Criar conta</button>
        </div>

        <div class="list" id="listaContas"></div>
      </div>

      <!-- TELA TRANSFER√äNCIAS -->
      <div id="telaTransf" class="hidden">
        <div class="form">
          <h2>Nova Transfer√™ncia</h2>

          <div class="row2">
            <div class="field"><label>Origem</label><select id="tOrigem"></select></div>
            <div class="field"><label>Destino</label><select id="tDestino"></select></div>
          </div>

          <div class="row2">
            <div class="field"><label>Valor</label><input id="tValor" type="number" step="0.01" placeholder="0,00"></div>
            <div class="field"><label>Data</label><input id="tData" type="date"></div>
          </div>

          <div class="field"><label>Descri√ß√£o</label><input id="tDesc" placeholder="Ex: Repasse despesas familiares"></div>
          <button class="main" onclick="criarTransferencia()">Salvar transfer√™ncia</button>
        </div>

        <div class="box">
          <h2>Transfer√™ncias do m√™s</h2>
          <div class="mini">Mostra as transfer√™ncias do m√™s selecionado na aba ‚ÄúM√™s‚Äù.</div>
        </div>

        <div class="list" id="listaTransf"></div>
      </div>

      <button class="sec" onclick="logout()">Sair</button>
    </div>
  </div>

  <!-- MODAL A√á√ïES -->
  <div id="actionsBack" class="modalBack hidden" onclick="closeActions(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHeader">
        <div class="modalTitle" id="actionsTitle">A√ß√µes</div>
        <button class="modalClose" onclick="closeActions()">X</button>
      </div>
      <div class="modalBody">
        <button class="modalBtn edit" onclick="actionsEdit()">‚úè Editar</button>
        <button class="modalBtn del" onclick="actionsDelete()">üóë Excluir</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAWyMjRVAODIVkC5w95nu9MliqNUMb8ZY",
      authDomain: "controle-financeiro-dffee.firebaseapp.com",
      projectId: "controle-financeiro-dffee",
      storageBucket: "controle-financeiro-dffee.firebasestorage.app",
      messagingSenderId: "470526358884",
      appId: "1:470526358884:web:0dcd3dffb5c0924dadf671"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const mesesNomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    let userId = null;
    let categorias = [];
    let contas = [];
    let dados = [];
    let transferencias = [];

    let grafMes = null;
    let grafAno = null;

    // state do modal de a√ß√µes
    let actionsCtx = { type:null, id:null };

    const $ = (id) => document.getElementById(id);

    // Inicializa meses
    mesesNomes.forEach((m, i) => {
      const o = document.createElement("option");
      o.value = String(i);
      o.text = m;
      if (i === new Date().getMonth()) o.selected = true;
      $("mesSelecionado").appendChild(o);
    });

    $("data").valueAsDate = new Date();
    $("tData").valueAsDate = new Date();

    $("repete").onchange = () => {
      $("parcelasBox").classList.toggle("hidden", $("repete").value !== "parcelada");
    };

    // Navega√ß√£o / tabs
    const telas = {
      mes: { el: () => $("telaMes"), tab: () => $("tabMes") },
      ano: { el: () => $("telaAno"), tab: () => $("tabAno") },
      contas: { el: () => $("telaContas"), tab: () => $("tabContas") },
      transf: { el: () => $("telaTransf"), tab: () => $("tabTransf") },
    };

    window.showTela = (nome) => {
      Object.keys(telas).forEach(k=>{
        telas[k].el().classList.toggle("hidden", k !== nome);
        telas[k].tab().classList.toggle("active", k === nome);
      });
      if (nome === "contas") renderContas();
      if (nome === "transf") renderTransferenciasMes();
      if (nome === "ano") renderAno();
      if (nome === "mes") renderMes();
    };

    window.showCadastro = () => {
      $("loginScreen").classList.add("hidden");
      $("cadastroScreen").classList.remove("hidden");
    };
    window.showLogin = () => {
      $("cadastroScreen").classList.add("hidden");
      $("loginScreen").classList.remove("hidden");
    };

    // Auth a√ß√µes
    $("btnLogin").onclick = () =>
      signInWithEmailAndPassword(auth, $("emailLogin").value, $("senhaLogin").value)
        .catch(() => alert("Email ou senha inv√°lidos"));

    $("btnCadastrar").onclick = () => {
      if ($("senhaCad").value !== $("senhaConf").value) return alert("As senhas n√£o conferem");
      createUserWithEmailAndPassword(auth, $("emailCad").value, $("senhaCad").value)
        .catch(() => alert("Erro ao criar conta"));
    };

    $("btnReset").onclick = () => {
      if (!$("emailLogin").value) return alert("Digite seu email");
      sendPasswordResetEmail(auth, $("emailLogin").value)
        .then(() => alert("Email enviado"))
        .catch(() => alert("Erro ao enviar email"));
    };

    $("btnGoogle").onclick = () =>
      signInWithPopup(auth, provider).catch(() => alert("Erro no login com Google"));

    window.logout = () => signOut(auth);

    async function garantirContaPadrao(){
      const snap = await getDocs(collection(db, "users", userId, "contas"));
      if (snap.size === 0) {
        await addDoc(collection(db,"users",userId,"contas"),{
          nome:"Conta Padr√£o",
          tipo:"corrente",
          saldoInicial:0,
          criadoEm:new Date()
        });
      }
    }

    async function carregarContas(){
      contas = [];
      const snap = await getDocs(collection(db, "users", userId, "contas"));
      snap.forEach(d => contas.push({id:d.id, ...d.data()}));
      contas.sort((a,b)=>{
        const ap = (a.nome||"").toLowerCase().includes("padr√£o");
        const bp = (b.nome||"").toLowerCase().includes("padr√£o");
        if (ap && !bp) return -1;
        if (!ap && bp) return 1;
        return (a.nome||"").localeCompare(b.nome||"");
      });
      preencherSelectContas();
      preencherFiltroContas();
    }

    function preencherSelectContas(){
      $("contaLanc").innerHTML = "";
      $("tOrigem").innerHTML = "";
      $("tDestino").innerHTML = "";

      contas.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.text = `${c.nome} (${c.tipo})`;
        $("contaLanc").appendChild(opt);

        const o1 = document.createElement("option");
        o1.value = c.id; o1.text = c.nome;
        const o2 = o1.cloneNode(true);
        $("tOrigem").appendChild(o1);
        $("tDestino").appendChild(o2);
      });
    }

    function preencherFiltroContas(){
      const sel = $("fConta");
      const atual = sel.value || "todas";
      sel.innerHTML = `<option value="todas">Todas as contas</option>`;
      contas.forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.text = c.nome;
        sel.appendChild(o);
      });
      sel.value = Array.from(sel.options).some(o=>o.value===atual) ? atual : "todas";
    }

    async function carregarCategorias(){
      categorias = [];
      const snap = await getDocs(collection(db, "users", userId, "categorias"));
      snap.forEach(d => categorias.push(d.data().nome));

      if (categorias.length === 0) {
        const base = ["Sal√°rio","Alimenta√ß√£o","Aluguel","Transporte","Lazer"];
        for (const c of base) await addDoc(collection(db, "users", userId, "categorias"), { nome: c });
        return carregarCategorias();
      }

      $("categoria").innerHTML = '<option value="">Selecione</option>';
      categorias.forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.text = c;
        $("categoria").appendChild(o);
      });
    }

    async function carregarLancamentos(){
      dados = [];
      const snap = await getDocs(collection(db, "users", userId, "lancamentos"));
      snap.forEach(d => dados.push({id:d.id, ...d.data()}));
    }

    async function carregarTransferencias(){
      transferencias = [];
      const snap = await getDocs(collection(db, "users", userId, "transferencias"));
      snap.forEach(d => transferencias.push({id:d.id, ...d.data()}));
    }

    async function carregarTudo(){
      await garantirContaPadrao();
      await carregarContas();
      await carregarCategorias();
      await carregarLancamentos();
      await carregarTransferencias();
      renderMes();
      renderAno();
      renderContas();
      renderTransferenciasMes();
    }

    // ====== MODAL A√á√ïES ======
    function openActions(type, id, title){
      actionsCtx = { type, id };
      $("actionsTitle").innerText = title || "A√ß√µes";
      $("actionsBack").classList.remove("hidden");
    }
    window.closeActions = (ev) => {
      if (ev && ev.target && ev.target.id !== "actionsBack") return;
      $("actionsBack").classList.add("hidden");
      actionsCtx = { type:null, id:null };
    };
    window.actionsEdit = async () => {
      const {type, id} = actionsCtx;
      if (!type || !id) return;

      if (type === "lanc") await editarLanc(id);
      if (type === "transf") await editarTransf(id);
      if (type === "conta") await editarConta(id);

      closeActions();
    };
    window.actionsDelete = async () => {
      const {type, id} = actionsCtx;
      if (!type || !id) return;

      if (type === "lanc") await excluirLancComFuturos(id);
      if (type === "transf") await excluirTransf(id);
      if (type === "conta") await excluirConta(id);

      closeActions();
    };

    // ====== CATEGORIA ======
    window.novaCategoria = async () => {
      const n = prompt("Nova categoria:");
      if (!n) return;
      await addDoc(collection(db,"users",userId,"categorias"),{nome:n});
      await carregarCategorias();
    };

    // ====== CONTAS ======
    window.criarConta = async () => {
      try{
        const nome = ($("contaNome").value || "").trim();
        const tipo = $("contaTipo").value;
        const saldoInicial = Number($("contaSaldoInicial").value || 0);
        if (!nome) return alert("Digite um nome para a conta.");

        await addDoc(collection(db,"users",userId,"contas"),{
          nome, tipo, saldoInicial, criadoEm:new Date()
        });

        $("contaNome").value = "";
        $("contaSaldoInicial").value = "0";

        await carregarContas();
        renderContas();
        renderAno();
        alert("Conta criada!");
      }catch(e){
        console.error(e);
        alert("Erro ao criar conta. Veja o console (F12).");
      }
    };

    async function editarConta(contaId){
      const c = contas.find(x=>x.id===contaId);
      if (!c) return;

      const novoNome = prompt("Novo nome da conta:", c.nome ?? "");
      if (novoNome === null) return;
      const nome = novoNome.trim();
      if (!nome) return alert("Nome inv√°lido.");

      const novoSaldo = prompt("Saldo inicial (altere apenas se necess√°rio):", String(c.saldoInicial ?? 0));
      if (novoSaldo === null) return;
      const saldoInicial = Number(novoSaldo);
      if (!Number.isFinite(saldoInicial)) return alert("Saldo inv√°lido.");

      try{
        await updateDoc(doc(db,"users",userId,"contas",contaId),{nome, saldoInicial});
        await carregarContas();
        renderContas();
        renderAno();
        renderMes();
      }catch(e){
        console.error(e);
        alert("Erro ao editar conta.");
      }
    }

    async function excluirConta(contaId){
      const c = contas.find(x=>x.id===contaId);
      if (!c) return;

      if ((c.nome||"").toLowerCase().includes("padr√£o")) {
        return alert("A Conta Padr√£o n√£o pode ser exclu√≠da.");
      }

      const temLanc = dados.some(l => (l.contaId || contas[0]?.id) === contaId);
      const temTransf = transferencias.some(t => t.origemId === contaId || t.destinoId === contaId);

      if (temLanc || temTransf) {
        return alert("Essa conta est√° em uso em lan√ßamentos/transfer√™ncias. Primeiro edite/apague esses itens, depois exclua a conta.");
      }

      if (!confirm(`Excluir a conta "${c.nome}"?`)) return;

      try{
        await deleteDoc(doc(db,"users",userId,"contas",contaId));
        await carregarContas();
        renderContas();
        renderAno();
        renderMes();
      }catch(e){
        console.error(e);
        alert("Erro ao excluir conta.");
      }
    }

    // ====== TRANSFER√äNCIAS ======
    window.criarTransferencia = async () => {
      try{
        const origemId = $("tOrigem").value;
        const destinoId = $("tDestino").value;
        const valor = Number($("tValor").value || 0);
        const dataStr = $("tData").value;
        const desc = ($("tDesc").value || "").trim();

        if (!origemId || !destinoId) return alert("Selecione origem e destino.");
        if (origemId === destinoId) return alert("Origem e destino devem ser diferentes.");
        if (!valor || valor <= 0) return alert("Informe um valor v√°lido.");
        if (!dataStr) return alert("Informe a data.");

        const mes = new Date(dataStr).getMonth();

        await addDoc(collection(db,"users",userId,"transferencias"),{
          origemId, destinoId, valor, data:dataStr, mes,
          desc, status:"confirmada", criadoEm:new Date()
        });

        $("tValor").value = "";
        $("tDesc").value = "";

        await carregarTransferencias();
        renderTransferenciasMes();
        renderContas();
        renderAno();
        alert("Transfer√™ncia salva!");
      }catch(e){
        console.error(e);
        alert("Erro ao salvar transfer√™ncia. Veja o console (F12).");
      }
    };

    async function editarTransf(id){
      const t = transferencias.find(x=>x.id===id);
      if (!t) return;

      const nv = prompt("Novo valor:", String(t.valor ?? 0));
      if (nv === null) return;
      const valor = Number(nv);
      if (!Number.isFinite(valor) || valor <= 0) return alert("Valor inv√°lido.");

      const nd = prompt("Nova descri√ß√£o:", String(t.desc ?? ""));
      if (nd === null) return;

      const newData = prompt("Nova data (AAAA-MM-DD):", String(t.data ?? ""));
      if (newData === null) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newData)) return alert("Data inv√°lida. Use AAAA-MM-DD.");

      const mes = new Date(newData).getMonth();

      try{
        await updateDoc(doc(db,"users",userId,"transferencias",id),{valor, desc:nd, data:newData, mes});
        await carregarTransferencias();
        renderTransferenciasMes();
        renderContas();
        renderAno();
      }catch(e){
        console.error(e);
        alert("Erro ao editar transfer√™ncia.");
      }
    }

    async function excluirTransf(id){
      const t = transferencias.find(x=>x.id===id);
      if (!t) return;

      if (!confirm("Excluir esta transfer√™ncia?")) return;

      try{
        await deleteDoc(doc(db,"users",userId,"transferencias",id));
        await carregarTransferencias();
        renderTransferenciasMes();
        renderContas();
        renderAno();
        renderMes();
      }catch(e){
        console.error(e);
        alert("Erro ao excluir transfer√™ncia.");
      }
    }

    // ====== LAN√áAMENTOS ======
    window.adicionarLancamento = async () => {
      if (!$("tipo").value || !$("categoria").value || !$("valor").value || !$("data").value || !$("repete").value) {
        return alert("Preencha todos os campos");
      }

      const contaId = $("contaLanc").value || (contas[0]?.id ?? null);

      const valorTotal = Number($("valor").value);
      const dataStr = $("data").value;
      const mesBase = new Date(dataStr).getMonth();
      const grupo = String(Date.now()) + "_" + Math.floor(Math.random()*1e6);

      const base = {
        tipo: $("tipo").value,
        cat: $("categoria").value,
        desc: $("desc").value || "",
        mes: mesBase,
        data: dataStr,
        grupo,
        status: "pendente",
        contaId
      };

      async function salvar(o){ await addDoc(collection(db,"users",userId,"lancamentos"), o); }

      if ($("repete").value === "fixa") {
        for (let m=mesBase; m<12; m++) await salvar({ ...base, mes:m, valor:valorTotal, fixed:true });
      } else if ($("repete").value === "parcelada") {
        const p = Number($("parcelas").value || 2);
        const vp = valorTotal / p;
        for (let i=0; i<p; i++) await salvar({ ...base, mes:(mesBase+i)%12, valor:vp, parcela:i+1, total:p });
      } else {
        await salvar({ ...base, valor:valorTotal });
      }

      $("desc").value=""; $("valor").value=""; $("repete").value=""; $("parcelas").value=2;
      $("parcelasBox").classList.add("hidden");

      await carregarLancamentos();
      renderMes();
      renderAno();
      renderContas();
    };

    async function editarLanc(id){
      const l = dados.find(i=>i.id===id);
      if (!l) return;

      const nv = prompt("Novo valor:", String(l.valor ?? ""));
      if (nv === null) return;
      const num = Number(nv);
      if (!Number.isFinite(num) || num < 0) return alert("Valor inv√°lido.");

      try{
        await updateDoc(doc(db,"users",userId,"lancamentos",id),{valor:num});
        await carregarLancamentos();
        renderMes(); renderAno(); renderContas();
      }catch(e){
        console.error(e);
        alert("Erro ao editar lan√ßamento.");
      }
    }

    // ‚úÖ Exclui este lan√ßamento + futuros pendentes do mesmo grupo
    async function excluirLancComFuturos(id){
      const item = dados.find(i=>i.id===id);
      if (!item) return;

      if (!confirm("Excluir este lan√ßamento e todos os futuros pendentes deste mesmo grupo?")) return;

      const grupo = item.grupo;
      const mesAtual = Number(item.mes);

      try{
        // pega todos do grupo
        const q = query(collection(db,"users",userId,"lancamentos"), where("grupo","==",grupo));
        const snap = await getDocs(q);

        // regra: apaga:
        // - o item clicado (sempre)
        // - os itens do mesmo grupo com status pendente e mes >= mesAtual
        for (const d of snap.docs) {
          const data = d.data();
          const docId = d.id;

          const isThis = (docId === id);
          const isFuturePending = (data.status === "pendente" && Number(data.mes) >= mesAtual);

          if (isThis || isFuturePending) {
            await deleteDoc(d.ref);
          }
        }

        await carregarLancamentos();
        renderMes(); renderAno(); renderContas();
      }catch(e){
        console.error(e);
        alert("Erro ao excluir lan√ßamentos do grupo.");
      }
    }

    window.pagar = async (id) => {
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pago"});
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    window.voltar = async (id) => {
      await updateDoc(doc(db,"users",userId,"lancamentos",id),{status:"pendente"});
      await carregarLancamentos();
      renderMes(); renderAno(); renderContas();
    };

    // ====== RENDER ======
    function nomeConta(id){
      const c = contas.find(x=>x.id===id);
      return c ? c.nome : "Conta Padr√£o";
    }

    function saldoConta(contaId){
      const conta = contas.find(c=>c.id===contaId);
      let saldo = Number(conta?.saldoInicial || 0);

      for (const l of dados) {
        const lConta = l.contaId || contas[0]?.id;
        if (l.status !== "pago") continue;
        if (lConta !== contaId) continue;
        if (l.tipo === "receita") saldo += Number(l.valor||0);
        if (l.tipo === "despesa") saldo -= Number(l.valor||0);
      }

      for (const t of transferencias) {
        if (t.status !== "confirmada") continue;
        if (t.origemId === contaId) saldo -= Number(t.valor||0);
        if (t.destinoId === contaId) saldo += Number(t.valor||0);
      }

      return saldo;
    }

    function saldoTotalTodasContas(){
      return contas.reduce((acc,c)=>acc + saldoConta(c.id), 0);
    }

    window.renderMes = () => {
      const mes = Number($("mesSelecionado").value);

      // totais (n√£o filtrados)
      let r = 0, d = 0;
      const cat = {};

      const itensMes = dados.filter(i => Number(i.mes) === mes);

      for (const i of itensMes) {
        if (i.status === "pago") {
          if (i.tipo === "receita") r += Number(i.valor||0);
          else d += Number(i.valor||0);
          if (i.tipo === "despesa") cat[i.cat] = (cat[i.cat] || 0) + Number(i.valor||0);
        }
      }

      $("rMes").innerText = `R$ ${r.toFixed(2)}`;
      $("dMes").innerText = `R$ ${d.toFixed(2)}`;
      $("sMes").innerText = `R$ ${(r-d).toFixed(2)}`;

      // filtros da lista
      const fConta = $("fConta").value;
      const fStatus = $("fStatus").value;
      const fBusca = ($("fBusca").value || "").trim().toLowerCase();

      let lista = itensMes.slice();
      if (fConta !== "todas") {
        lista = lista.filter(i => (i.contaId || contas[0]?.id) === fConta);
      }
      if (fStatus !== "todos") {
        lista = lista.filter(i => i.status === fStatus);
      }
      if (fBusca) {
        lista = lista.filter(i =>
          String(i.cat||"").toLowerCase().includes(fBusca) ||
          String(i.desc||"").toLowerCase().includes(fBusca)
        );
      }

      lista.sort((a,b)=> String(a.data||"").localeCompare(String(b.data||"")));

      $("listaMes").innerHTML = "<h2>Lan√ßamentos</h2>";

      for (const i of lista) {
        const statusTxt = (i.status === "pago") ? "Pago" : "Pendente";
        const contaNome = nomeConta(i.contaId || contas[0]?.id);

        let info = i.desc || "";
        if (i.parcela) info += ` (${i.parcela}/${i.total})`;
        if (i.fixed) info += " (Fixa)";

        const div = document.createElement("div");
        div.className = "tx";

        const isPendente = i.status === "pendente";

        div.innerHTML = `
          <div>
            <div class="title">${i.cat}</div>
            <div class="meta">${info} ‚Ä¢ ${contaNome} ‚Ä¢ ${statusTxt}</div>
          </div>

          <div class="right">
            <div class="amount ${i.tipo==='receita'?'rec':'desp'}">R$ ${Number(i.valor||0).toFixed(2)}</div>

            ${
              isPendente
              ? `<button class="iconBtn ok" title="Confirmar pagamento" onclick="pagar('${i.id}')">‚úî</button>`
              : `<button class="iconBtn undo" title="Marcar como pendente" onclick="voltar('${i.id}')">‚Ü©</button>`
            }

            <button class="iconBtn" title="Editar/Excluir" onclick="openActions('lanc','${i.id}','A√ß√µes do lan√ßamento')">‚ãØ</button>
          </div>
        `;

        $("listaMes").appendChild(div);
      }

      if (!grafMes) {
        grafMes = new Chart($("graficoMes"), {
          type:'pie',
          data:{ labels:[], datasets:[{ data:[], backgroundColor:["#22c55e","#3b82f6","#f59e0b","#ef4444","#a855f7","#14b8a6"] }] }
        });
      }
      grafMes.data.labels = Object.keys(cat);
      grafMes.data.datasets[0].data = Object.values(cat);
      grafMes.update();

      renderTransferenciasMes();
    };

    window.renderAno = () => {
      let rM = Array(12).fill(0), dM = Array(12).fill(0), r=0, d=0;
      for (const i of dados) {
        if (i.status !== "pago") continue;
        const m = Number(i.mes);
        if (i.tipo === "receita") { r += Number(i.valor||0); rM[m] += Number(i.valor||0); }
        else { d += Number(i.valor||0); dM[m] += Number(i.valor||0); }
      }

      $("rAno").innerText = `R$ ${r.toFixed(2)}`;
      $("dAno").innerText = `R$ ${d.toFixed(2)}`;
      $("sAno").innerText = `R$ ${(r-d).toFixed(2)}`;
      $("saldoTotal").innerText = `R$ ${saldoTotalTodasContas().toFixed(2)}`;

      if (!grafAno) {
        grafAno = new Chart($("graficoAno"), {
          type:'bar',
          data:{ labels: mesesNomes, datasets:[
            {label:'Receitas', data:[], backgroundColor:"#22c55e"},
            {label:'Despesas', data:[], backgroundColor:"#ef4444"}
          ]}
        });
      }
      grafAno.data.datasets[0].data = rM;
      grafAno.data.datasets[1].data = dM;
      grafAno.update();
    };

    window.renderContas = () => {
      $("listaContas").innerHTML = `
        <h2>Saldos por conta</h2>
        <div class="mini">Baseado em lan√ßamentos <b>pagos</b> e transfer√™ncias <b>confirmadas</b>.</div>
        <div class="accountsGrid" id="accGrid"></div>
      `;

      const grid = document.getElementById("accGrid");

      contas.forEach(c=>{
        const saldo = saldoConta(c.id);
        const posNeg = saldo >= 0 ? "pos" : "neg";

        const div = document.createElement("div");
        div.className = "acc";
        div.innerHTML = `
          <div>
            <div class="name">${c.nome}</div>
            <div class="type">${c.tipo} ‚Ä¢ saldo inicial: R$ ${Number(c.saldoInicial||0).toFixed(2)}</div>
          </div>

          <div style="display:flex; gap:10px; align-items:flex-start;">
            <div class="bal ${posNeg}">R$ ${saldo.toFixed(2)}</div>
            <button class="iconBtn" title="Editar/Excluir conta" onclick="openActions('conta','${c.id}','A√ß√µes da conta')">‚ãØ</button>
          </div>
        `;
        grid.appendChild(div);
      });
    };

    window.renderTransferenciasMes = () => {
      const mes = Number($("mesSelecionado").value);
      $("listaTransf").innerHTML = "";

      const itens = transferencias
        .filter(t => Number(t.mes) === mes)
        .sort((a,b)=> String(a.data||"").localeCompare(String(b.data||"")));

      if (itens.length === 0) {
        $("listaTransf").innerHTML = `<div class="mini">Nenhuma transfer√™ncia neste m√™s.</div>`;
        return;
      }

      itens.forEach(t=>{
        const div = document.createElement("div");
        div.className = "tr";
        div.innerHTML = `
          <div>
            <div class="title">${nomeConta(t.origemId)} ‚Üí ${nomeConta(t.destinoId)}</div>
            <div class="meta">${t.desc || ""} ‚Ä¢ ${t.data || ""}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div class="val">R$ ${Number(t.valor||0).toFixed(2)}</div>
            <button class="iconBtn" title="Editar/Excluir transfer√™ncia" onclick="openActions('transf','${t.id}','A√ß√µes da transfer√™ncia')">‚ãØ</button>
          </div>
        `;
        $("listaTransf").appendChild(div);
      });
    };

    // ====== FILTRO CONTAS ======
    function preencherFiltroContas(){
      const sel = $("fConta");
      const atual = sel.value || "todas";
      sel.innerHTML = `<option value="todas">Todas as contas</option>`;
      contas.forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.text = c.nome;
        sel.appendChild(o);
      });
      sel.value = Array.from(sel.options).some(o=>o.value===atual) ? atual : "todas";
    }

    // ====== AUTH ======
    onAuthStateChanged(auth, async (u) => {
      if (u) {
        userId = u.uid;
        $("loginScreen").classList.add("hidden");
        $("cadastroScreen").classList.add("hidden");
        $("appScreen").classList.remove("hidden");

        await carregarTudo();
      } else {
        $("appScreen").classList.add("hidden");
        showLogin();
      }
    });

    // exp√µe para HTML
    window.openActions = openActions;
    window.editarConta = editarConta;
    window.excluirConta = excluirConta;
    window.editarLanc = editarLanc;
    window.excluirLancComFuturos = excluirLancComFuturos;
    window.editarTransf = editarTransf;
    window.excluirTransf = excluirTransf;
  </script>
</body>
</html>

